
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Web Server &#8212; RobotDyn  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="web-server">
<h1>Web Server<a class="headerlink" href="#web-server" title="Permalink to this headline">¶</a></h1>
<p>In the following example, we will create a sketch that turns your Mega ETH board to a Web Server that serves just one static HTML page that it reads from a file on an SD card.</p>
<div class="section" id="creating-the-web-page">
<h2>Creating the Web Page<a class="headerlink" href="#creating-the-web-page" title="Permalink to this headline">¶</a></h2>
<p>Let’s create a simple HTML page and store it on an SD card using your computer and a card reader. While you can use almost any text editor to write HTML code, it will be much easier if it can highlight the HTML syntaxis and automatically close HTML tags. Geany (geany.org) is an example of such an editor available on almost all operating systems.
Create the following web page in the editor:</p>
<div class="highlight-HTML notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Test SD Card Web Page<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Hello from the Mega ETH Web Server!<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>An example web page stored on the SD card.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>Store it on the SD card in the root directory as <em>index.html</em>.</p>
</div>
<div class="section" id="preparing-the-sketch">
<h2>Preparing the sketch<a class="headerlink" href="#preparing-the-sketch" title="Permalink to this headline">¶</a></h2>
<p>We will need to configure the pin 4 for the SD card reader to work, then we initialize the network library, generate a presumably unique MAC address following our previous recommendations of setting the first byte of MAC address to 0xDE for better network equipment compatibility and store that MAC address in the microcontroller’s EEPROM.</p>
<p>We will use DHCP to query an available IP address from the network router and display the IP address on a 16x2 LCD monitor because we need to type that IP address into a browser, that must be running on a computer on the same local network.</p>
<p>We assume that the HTML file is already stored on the SD card and the card is inserted into the onboard card reader.</p>
<p>Let’s get down to the code:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Ethernet3.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;EEPROM.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;LiquidCrystal.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;SD.h&gt;</span><span class="cp"></span>

<span class="n">byte</span> <span class="n">mac</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
<span class="kt">char</span> <span class="n">macstr</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>

<span class="c1">// initialize the LCD library with the numbers of the interface pins</span>
<span class="n">LiquidCrystal</span> <span class="nf">lcd</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="n">EthernetServer</span> <span class="nf">server</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>  <span class="c1">// create a server at port 80</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">lcd</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">//Initialize the 16x2 LCD screen</span>

  <span class="c1">// Check EEPROM byte with offset==0 for “#” char. The presence of “#” in the first byte of EEPROM will be a sign that the MAC address was already generated and stored in bytes 1-7 of EEPROM. Otherwise, we need to generate a random MAC, put “#” at offset 0 and the MAC in the following 6 bytes</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">EEPROM</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EEPROM</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">randomSeed</span><span class="p">(</span><span class="n">analogRead</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xde</span><span class="p">;</span>
    <span class="n">EEPROM</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
      <span class="n">EEPROM</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">EEPROM</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;#&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Startup networking, get IP, DNS, and subnet from the DHCP server</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">linkStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">LinkOFF</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">lcd</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;LINK FAILURE&quot;</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
            <span class="n">lcd</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;DHCP ERROR!&quot;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="c1">// success, display your local IP address:</span>
         <span class="n">lcd</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span> <span class="c1">//You can enter this IP in your web browser</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// listen for incoming clients</span>
  <span class="n">EthernetClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">available</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// got client?</span>
        <span class="n">boolean</span> <span class="n">currentLineIsBlank</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>   <span class="c1">// client data available to read</span>
                <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">read</span><span class="p">();</span> <span class="c1">// read 1 byte (character) from client</span>
                <span class="c1">// last line of client request is blank and ends with \n</span>
                <span class="c1">// respond to client only after last line received</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">currentLineIsBlank</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// send a standard http response header</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;HTTP/1.1 200 OK&quot;</span><span class="p">);</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Content-Type: text/html&quot;</span><span class="p">);</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Connection: close&quot;</span><span class="p">);</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
                    <span class="c1">// send web page</span>
                    <span class="n">webFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;index.htm&quot;</span><span class="p">);</span>        <span class="c1">// open web page file</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">webFile</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">while</span><span class="p">(</span><span class="n">webFile</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
                            <span class="n">client</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">webFile</span><span class="p">.</span><span class="n">read</span><span class="p">());</span> <span class="c1">// send web page to client</span>
                        <span class="p">}</span>
                        <span class="n">webFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// every line of text received from the client ends with \r\n</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// last character on line of received text</span>
                    <span class="c1">// starting new line with next character read</span>
                    <span class="n">currentLineIsBlank</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// a text character was received from client</span>
                    <span class="n">currentLineIsBlank</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="c1">// end if (client.available())</span>
        <span class="p">}</span> <span class="c1">// end while (client.connected())</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>      <span class="c1">// give the web browser time to receive the data</span>
        <span class="n">client</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span> <span class="c1">// close the connection</span>
    <span class="p">}</span> <span class="c1">// end of session with client</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">RobotDyn</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, RobotDyn.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/Mega ETH/en/Tutorials/WebServer.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>