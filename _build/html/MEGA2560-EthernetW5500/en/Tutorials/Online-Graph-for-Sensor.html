
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Online Graph Using Mega 2560 ETH Web Server with No External Services &#8212; RobotDyn  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="online-graph-using-mega-2560-eth-web-server-with-no-external-services">
<h1>Online Graph Using Mega 2560 ETH Web Server with No External Services</h1>
<p>In the following example, we will create a sketch that turns your Mega
ETH board to a Web Server that serves a graphical representation of a valure provided by a connected sensor (light sensor for this example). Since microcontroller resources are very limited, it is a common practice to use additional web services for more complex tasks like graphical representation of information. But if we don’t want to depend on an external service, free or commercial, we might want to try to implement everything using nothing but the board, which is actually possible.</p>
<div class="section" id="connecting-a-sensor">
<h2>Connecting a Sensor</h2>
<p>We connect a photoresistor to 5V, GND and A0 pins of Mega 2560 ETH in such a way that the minimum light intensity is zero, while the maximum is 1024.</p>
<p><img alt="Fig 1. Sensor connection diagram" src="../../../_images/photosensor.svg" /></p>
</div>
<div class="section" id="preparing-the-web-page-on-sd-card">
<h2>Preparing the Web Page on SD Card</h2>
<p>Let’s create a simple HTML page and store it on an SD card using your
computer and a card reader. While you can use almost any text editor to
write HTML code, it will be much easier if it can highlight the HTML
syntaxis and automatically close HTML tags. Geany (geany.org) is an
example of such an editor available on almost all operating systems.
Create the following web page in the editor:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Super Graphing Data Logger!<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
 
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;</span>
<span class="kd">function</span> <span class="nx">getDataFilename</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span>
    <span class="nx">point</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s2">&quot;file=&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
 
    <span class="nx">tempString</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">point</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tempString</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
    <span class="k">return</span><span class="p">(</span><span class="nx">tempString</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="nx">tempString</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">tempString</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">));</span>
    <span class="p">}</span>
         
<span class="p">}</span>
 
<span class="nx">query</span>  <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">;</span>
 
<span class="kd">var</span> <span class="nx">dataFilePath</span> <span class="o">=</span> <span class="s2">&quot;/data/&quot;</span><span class="o">+</span><span class="nx">getDataFilename</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
 
<span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
     
        <span class="c1">// define the options</span>
        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
     
            <span class="nx">chart</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">renderTo</span><span class="o">:</span> <span class="s1">&#39;container&#39;</span><span class="p">,</span>
                <span class="nx">zoomType</span><span class="o">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
                <span class="nx">spacingRight</span><span class="o">:</span> <span class="mi">20</span>
            <span class="p">},</span>
     
            <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Light levels recorded by the Arduino&#39;</span>
            <span class="p">},</span>
     
            <span class="nx">subtitle</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Click and drag in the plot area to zoom in&#39;</span>
            <span class="p">},</span>
     
            <span class="nx">xAxis</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span>
                <span class="nx">maxZoom</span><span class="o">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">3600000</span>
            <span class="p">},</span>
     
            <span class="nx">yAxis</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Light Levels (0 - 1024)&#39;</span>
                <span class="p">},</span>
                <span class="nx">min</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="nx">startOnTick</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">showFirstLabel</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">},</span>
     
            <span class="nx">legend</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">enabled</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">},</span>
     
            <span class="nx">tooltip</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">formatter</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="s1">&#39;&lt;b&gt;&#39;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">series</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span><span class="s1">&#39;&lt;/b&gt;&lt;br/&gt;&#39;</span><span class="o">+</span>
                        <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">dateFormat</span><span class="p">(</span><span class="s1">&#39;%H:%M - %b %e, %Y&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">},</span>
     
            <span class="nx">plotOptions</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">series</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">cursor</span><span class="o">:</span> <span class="s1">&#39;pointer&#39;</span><span class="p">,</span>
                    <span class="nx">lineWidth</span><span class="o">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="nx">point</span><span class="o">:</span> <span class="p">{</span>
                        <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
                            <span class="nx">click</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                                <span class="nx">hs</span><span class="p">.</span><span class="nx">htmlExpand</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
                                    <span class="nx">pageOrigin</span><span class="o">:</span> <span class="p">{</span>
                                        <span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span>
                                        <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">pageY</span>
                                    <span class="p">},</span>
                                    <span class="nx">headingText</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">series</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                                    <span class="nx">maincontentText</span><span class="o">:</span> <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">dateFormat</span><span class="p">(</span><span class="s1">&#39;%H:%M - %b %e, %Y&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;:&lt;br/&gt; &#39;</span><span class="o">+</span>
                                        <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
                                    <span class="nx">width</span><span class="o">:</span> <span class="mi">200</span>
                                <span class="p">});</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">},</span>
     
            <span class="nx">series</span><span class="o">:</span> <span class="p">[{</span>
                <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Light Levels&#39;</span><span class="p">,</span>
                <span class="nx">marker</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">radius</span><span class="o">:</span> <span class="mi">2</span>
                <span class="p">}</span>
            <span class="p">}]</span>
        <span class="p">};</span>
     
     
        <span class="c1">// Load data asynchronously using jQuery. On success, add the data</span>
        <span class="c1">// to the options and initiate the chart.</span>
        <span class="c1">//  http://api.jquery.com/jQuery.get/</span>

        <span class="nx">jQuery</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">dataFilePath</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">csv</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">date</span><span class="p">,</span>
     
                <span class="c1">// set up the two data series</span>
                <span class="nx">lightLevels</span> <span class="o">=</span> <span class="p">[];</span>
     
            <span class="c1">// inconsistency</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">csv</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">csv</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
            <span class="p">}</span>
     
            <span class="c1">// split the data return into lines and parse them</span>
            <span class="nx">csv</span> <span class="o">=</span> <span class="nx">csv</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">);</span>
            <span class="nx">jQuery</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">csv</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
     
                <span class="c1">// all data lines start with a double quote</span>
                <span class="nx">line</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
                <span class="nx">date</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
     
                <span class="nx">lightLevels</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
                    <span class="nx">date</span><span class="p">,</span>
                    <span class="nb">parseInt</span><span class="p">(</span><span class="nx">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
                <span class="p">]);</span>
                 
            <span class="p">});</span>
     
            <span class="nx">options</span><span class="p">.</span><span class="nx">series</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">lightLevels</span><span class="p">;</span>
     
            <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">Chart</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
     
<span class="p">});</span>
        <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;text-align:center;&quot;</span><span class="p">&gt;</span>Please allow the chart to load, it may take up to 30 seconds <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">hr</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://cdnjs.cloudflare.com/ajax/libs/highcharts/2.3.5/highcharts.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
 
<span class="c">&lt;!-- Additional files for the Highslide popup effect --&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://www.highcharts.com/highslide/highslide-full.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://www.highcharts.com/highslide/highslide.config.js&quot;</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;http://www.highcharts.com/highslide/highslide.css&quot;</span> <span class="p">/&gt;</span>
 
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;container&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;min-width: 400px; height: 400px; margin: 0 auto&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
 
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>Store it on the SD card in the root directory as <em>index.html</em>.</p>
</div>
<div class="section" id="preparing-the-sketch">
<h2>Preparing the sketch</h2>
<p>Our sketch will be placed in EEPROM and will make use of 2 extra libraries: <a class="reference external" href="http://playground.arduino.cc/Code/EEPROMWriteAnything">EEPROMAnything</a> and <a class="reference external" href="http://playground.arduino.cc/Code/Time">Time library</a>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* ************************************************************************</span>
<span class="cm"> * ***            Super Graphing Data Logger - EEPROM config            ***</span>
<span class="cm"> * ************************************************************************</span>
<span class="cm"> * Everett Robinson, December 2012.</span>
<span class="cm"> *</span>
<span class="cm"> * The following extra non standard libraries were used, and will need to be</span>
<span class="cm"> * added to the libraries folder:</span>
<span class="cm"> * - EEPROMAnything:  http://playground.arduino.cc/Code/EEPROMWriteAnyt...</span>
<span class="cm"> *</span>
<span class="cm"> * This sketch helps you set the values in EEPROM which are necessary for</span>
<span class="cm"> * Super Graphing Data Logger. It should only need the be run once before</span>
<span class="cm"> * the first time you set up SGDL, or in the unlikely event that the EEPROM</span>
<span class="cm"> * becomes corrupted.</span>
<span class="cm"> *</span>
<span class="cm"> * Please ensure that the values in configuration config are appropriate for</span>
<span class="cm"> * your project before uncommenting the EEPROM_writeAnything(0, config); line.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
 
<span class="cp">#include</span> <span class="cpf">&lt;EEPROM.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;EEPROMAnything.h&gt;</span><span class="cp"></span>
 
<span class="k">typedef</span> <span class="k">struct</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newFileTime</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">workingFilename</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>
  <span class="p">}</span> <span class="n">configuration</span><span class="p">;</span>
 
<span class="c1">//This is a one off thing, so everything is in setup</span>
<span class="kt">void</span> <span class="nf">setup</span><span class="p">(){</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
   
  <span class="c1">//Create the config struct to write to EEPROM, change values as appropriate</span>
  <span class="c1">//Make sure your filename is not too long for the workingFilename char array </span>
  <span class="n">configuration</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1356912000L</span><span class="p">,</span><span class="s">&quot;/data/25-12-12.csv&quot;</span><span class="p">};</span>
  <span class="c1">//Write the values to the EEPROM</span>
  <span class="c1">//EEPROM_writeAnything(0, config);       //Uncomment when you&#39;re sure everything is correct</span>
  <span class="n">configuration</span> <span class="n">config2</span><span class="p">;</span>                   <span class="c1">//Create a second config struct for verification</span>
  <span class="n">EEPROM_readAnything</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">config2</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;The value read from EEPROM for newFileTime is: &quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">config2</span><span class="p">.</span><span class="n">newFileTime</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;The value read from EEPROM for workingFilename is: &quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">config2</span><span class="p">.</span><span class="n">workingFilename</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;If those values are correct then everything went as planned. Otherwise,&quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;please double check that the values declared for the struct config are&quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;correct and that that EEPROM_writeAnything line is uncommented.&quot;</span><span class="p">);</span>
<span class="p">}</span>
 
 
<span class="kt">void</span> <span class="nf">loop</span><span class="p">(){</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Please mind the commented line <code class="docutils literal notranslate"><span class="pre">//EEPROM_writeAnything(0,</span> <span class="pre">config);</span></code> - uncomment itwhen you are sure that everything is correct.</p>
</div>
<div class="section" id="the-main-sketch">
<h2>The main sketch</h2>
<p>You will need to do a few adjustments to the code, like MAC and IP addresses. You can also adjust the timeserver address to your liking.</p>
<p>The code is set up to make measurements every 10 minutes, and to create a new datafile every week. Data files use a dd-mm-yy.csv format.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="cm">/* ************************************************************************</span>
<span class="cm"> * ***                    Super Graphing Data Logger                    ***</span>
<span class="cm"> * ************************************************************************</span>
<span class="cm"> * Everett Robinson, December 2012. More at:  http://everettsprojects.com</span>
<span class="cm"> *</span>
<span class="cm"> * This sketch relies on the SD and ethernet libraries in arduino 1.0 or newer.</span>
<span class="cm"> * The following extra non standard libraries were also used, and will need to</span>
<span class="cm"> * be added to the libraries folder:</span>
<span class="cm"> * - Time:  http://everettsprojects.com</span>
<span class="cm"> * - EEPROMAnything:  http://everettsprojects.com</span>
<span class="cm"> *</span>
<span class="cm"> * If this is your first time setting up this project, please go get the</span>
<span class="cm"> * EEPROM_config sketch from  http://everettsprojects.com so that you can </span>
<span class="cm"> * configure the config struct in the EEPROM memory. Usage of the EEPROM </span>
<span class="cm"> * is needed to make the project resiliant against a temporary loss of power.</span>
<span class="cm"> *</span>
<span class="cm"> * You must also ensure that you have the HC.htm file in the root directory</span>
<span class="cm"> * of your SD card, as well as a data directory where the datafiles will be</span>
<span class="cm"> * stored.</span>
<span class="cm"> *</span>
<span class="cm"> * This sketch combines the functionality of an existing fileserver example</span>
<span class="cm"> * which can be found at  http://everettsprojects.com</span>
<span class="cm"> * with the Datalogger example that comes with the new SD library from 1.0,</span>
<span class="cm"> * as well as some code from the UdpNtpClient example that cones with the</span>
<span class="cm"> * ethernet library. </span>
<span class="cm"> *</span>
<span class="cm"> * Added to all of these are some tricks to make it manage and serve up the</span>
<span class="cm"> * datafiles in conjunction with a page which uses highcharts JS to graph it.</span>
<span class="cm"> * This is basically accomplished using the arduino by itself. Because I</span>
<span class="cm"> * actually host the highcharts.js files externally, this is true more in</span>
<span class="cm"> * theory than in actual practice, but oh well. It should work just fine to</span>
<span class="cm"> * have the highcharts.js file on the arduino&#39;s SD card, though loading the </span>
<span class="cm"> * page will be painfully slow.</span>
<span class="cm"> *</span>
<span class="cm"> * Some of the code this was derived from may or may not be under a GPL</span>
<span class="cm"> * licence; I&#39;m not entirely sure. I suppose anyone using this should treat </span>
<span class="cm"> * it like it is too, but I don&#39;t really care too much.</span>
<span class="cm"> * Also if one intends to use this for commercial applications, it may be</span>
<span class="cm"> * necessary to purchase a license for Highcharts.</span>
<span class="cm"> *</span>
<span class="cm"> * Changes:   -------------------------------------------------------------</span>
<span class="cm"> * January 2013: Updated so that the dd-mm-yy.csv file format is properly </span>
<span class="cm"> * followed, all single digit days, months, and years will have a leading </span>
<span class="cm"> * zero now. </span>
<span class="cm"> *</span>
<span class="cm"> */</span>
 
<span class="cp">#include</span> <span class="cpf">&lt;sd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;ethernet.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;ethernetudp.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;spi.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;eeprom.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;eepromanything.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;avr/pgmspace.h&gt;</span><span class="cp"></span>
 
<span class="cm">/************ ETHERNET STUFF ************/</span>
<span class="n">byte</span> <span class="n">mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">};</span>
<span class="n">byte</span> <span class="n">ip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">192</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span> <span class="p">};</span>
<span class="n">EthernetServer</span> <span class="nf">server</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
 
<span class="cm">/************** NTP STUFF ***************/</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">localPort</span> <span class="o">=</span> <span class="mi">8888</span><span class="p">;</span>          <span class="c1">// local port to listen for UDP packets</span>
<span class="n">IPAddress</span> <span class="nf">timeServer</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">101</span><span class="p">);</span> <span class="c1">//NIST time server IP address: for more info</span>
                                        <span class="c1">//see  http://everettsprojects.com</span>
 
<span class="k">const</span> <span class="kt">int</span> <span class="n">NTP_PACKET_SIZE</span><span class="o">=</span> <span class="mi">48</span><span class="p">;</span> <span class="c1">//NTP time stamp is in the first 48 bytes of the message</span>
<span class="n">byte</span> <span class="n">packetBuffer</span><span class="p">[</span> <span class="n">NTP_PACKET_SIZE</span><span class="p">];</span> <span class="c1">//buffer to hold incoming and outgoing packets </span>
<span class="n">EthernetUDP</span> <span class="n">Udp</span><span class="p">;</span>
 
<span class="cm">/*** DATA LOGGER AND TIMER CONTROLS ****/</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">analogPin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lastIntervalTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//The time the last measurement occured.</span>
<span class="cp">#define MEASURE_INTERVAL 600000     </span><span class="c1">//10 minute intervals between measurements (in ms)</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newFileTime</span><span class="p">;</span>          <span class="c1">//The time at which we should create a new week&#39;s file</span>
<span class="cp">#define FILE_INTERVAL 604800        </span><span class="c1">//One week worth of seconds</span>
 
<span class="c1">//A structure that stores file config variables from EEPROM</span>
<span class="k">typedef</span> <span class="k">struct</span><span class="p">{</span>                     
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newFileTime</span><span class="p">;</span>      <span class="c1">//Keeps track of when a newfile should be made.</span>
    <span class="kt">char</span> <span class="n">workingFilename</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>       <span class="c1">//The path and filename of the current week&#39;s file</span>
<span class="p">}</span> <span class="n">configuration</span><span class="p">;</span>
   
<span class="n">configuration</span> <span class="n">config</span><span class="p">;</span>               <span class="c1">//Actually make our config struct</span>
 
 
<span class="c1">// Strings stored in flash mem for the Html Header (saves ram)</span>
<span class="n">prog_char</span> <span class="n">HeaderOK_0</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;HTTP/1.1 200 OK&quot;</span><span class="p">;</span>            <span class="c1">//</span>
<span class="n">prog_char</span> <span class="n">HeaderOK_1</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;Content-Type: text/html&quot;</span><span class="p">;</span>    <span class="c1">//</span>
<span class="n">prog_char</span> <span class="n">HeaderOK_2</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>                           <span class="c1">//</span>
 
<span class="c1">// A table of pointers to the flash memory strings for the header</span>
<span class="n">PROGMEM</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">HeaderOK_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>   
  <span class="n">HeaderOK_0</span><span class="p">,</span>
  <span class="n">HeaderOK_1</span><span class="p">,</span>
  <span class="n">HeaderOK_2</span>
<span class="p">};</span>
 
<span class="c1">// A function for easy printing of the headers  </span>
<span class="kt">void</span> <span class="nf">HtmlHeaderOK</span><span class="p">(</span><span class="n">EthernetClient</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
   
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span> <span class="c1">//A character array to hold the strings from the flash mem</span>
     
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">strcpy_P</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pgm_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">HeaderOK_table</span><span class="p">[</span><span class="n">i</span><span class="p">])));</span> 
      <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span> <span class="n">buffer</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span> 
   
   
<span class="c1">// Strings stored in flash mem for the Html 404 Header</span>
<span class="n">prog_char</span> <span class="n">Header404_0</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;HTTP/1.1 404 Not Found&quot;</span><span class="p">;</span>     <span class="c1">//</span>
<span class="n">prog_char</span> <span class="n">Header404_1</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;Content-Type: text/html&quot;</span><span class="p">;</span>    <span class="c1">//</span>
<span class="n">prog_char</span> <span class="n">Header404_2</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>                           <span class="c1">//</span>
<span class="n">prog_char</span> <span class="n">Header404_3</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;&lt;h2&gt;File Not Found!&lt;/h2&gt;&quot;</span><span class="p">;</span> 
 
<span class="c1">// A table of pointers to the flash memory strings for the header</span>
<span class="n">PROGMEM</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Header404_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>   
  <span class="n">Header404_0</span><span class="p">,</span>
  <span class="n">Header404_1</span><span class="p">,</span>
  <span class="n">Header404_2</span><span class="p">,</span>
  <span class="n">Header404_3</span>
<span class="p">};</span>
 
<span class="c1">// Easy peasy 404 header function</span>
<span class="kt">void</span> <span class="nf">HtmlHeader404</span><span class="p">(</span><span class="n">EthernetClient</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
   
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span> <span class="c1">//A character array to hold the strings from the flash mem</span>
     
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">strcpy_P</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pgm_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">Header404_table</span><span class="p">[</span><span class="n">i</span><span class="p">])));</span> 
      <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span> <span class="n">buffer</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span> 
 
 
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
   
  <span class="n">pinMode</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>          <span class="c1">// set the SS pin as an output (necessary!)</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>       <span class="c1">// but turn off the W5100 chip! </span>
   
  <span class="c1">// see if the card is present and can be initialized:</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SD</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Card failed, or not present&quot;</span><span class="p">);</span>
    <span class="c1">// don&#39;t do anything more:</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;card initialized.&quot;</span><span class="p">);</span>
   
  <span class="c1">// The SD card is working, start the server and ethernet related stuff!</span>
  <span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="n">Udp</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">localPort</span><span class="p">);</span>
  <span class="n">EEPROM_readAnything</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">config</span><span class="p">);</span> <span class="c1">// make sure our config struct is syncd with EEPROM</span>
<span class="p">}</span>
 
 
<span class="c1">// A function that takes care of the listing of files for the</span>
<span class="c1">// main page one sees when they first connect to the arduino.</span>
<span class="c1">// it only lists the files in the /data/ folder. Make sure this</span>
<span class="c1">// exists on your SD card.</span>
<span class="kt">void</span> <span class="nf">ListFiles</span><span class="p">(</span><span class="n">EthernetClient</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
   
  <span class="n">File</span> <span class="n">workingDir</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/data&quot;</span><span class="p">);</span>
   
  <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;&lt;ul&gt;&quot;</span><span class="p">);</span>
   
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">File</span> <span class="n">entry</span> <span class="o">=</span>  <span class="n">workingDir</span><span class="p">.</span><span class="n">openNextFile</span><span class="p">();</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">break</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="n">client</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;&lt;li&gt;&lt;a href=</span><span class="se">\&quot;</span><span class="s">/HC.htm?file=&quot;</span><span class="p">);</span>
       <span class="n">client</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">());</span>        
       <span class="n">client</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="p">);</span>
       <span class="n">client</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">());</span>
       <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;&lt;/a&gt;&lt;/li&gt;&quot;</span><span class="p">);</span>
       <span class="n">entry</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;&lt;/ul&gt;&quot;</span><span class="p">);</span>
  <span class="n">workingDir</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="c1">// A function to get the Ntp Time. This is used to make sure that the data</span>
<span class="c1">// points recorded by the arduino are referenced to some meaningful time</span>
<span class="c1">// which in our case is UTC represented as unix time (choosen because it </span>
<span class="c1">// works simply with highcharts without too much unecessary computation).</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">getTime</span><span class="p">(){</span>
  <span class="n">sendNTPpacket</span><span class="p">(</span><span class="n">timeServer</span><span class="p">);</span> <span class="c1">// send an NTP packet to a time server</span>
 
  <span class="c1">// wait to see if a reply is available</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>  
  <span class="k">if</span> <span class="p">(</span> <span class="n">Udp</span><span class="p">.</span><span class="n">parsePacket</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>  
    <span class="c1">// We&#39;ve received a packet, read the data from it</span>
    <span class="n">Udp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span><span class="n">NTP_PACKET_SIZE</span><span class="p">);</span>  <span class="c1">// read the packet into the buffer</span>
 
    <span class="c1">//the timestamp starts at byte 40 of the received packet and is four bytes,</span>
    <span class="c1">// or two words, long. First, esxtract the two words:</span>
 
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">highWord</span> <span class="o">=</span> <span class="n">word</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">[</span><span class="mi">40</span><span class="p">],</span> <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">41</span><span class="p">]);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lowWord</span> <span class="o">=</span> <span class="n">word</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">[</span><span class="mi">42</span><span class="p">],</span> <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">43</span><span class="p">]);</span>  
    <span class="c1">// combine the four bytes (two words) into a long integer</span>
    <span class="c1">// this is NTP time (seconds since Jan 1 1900):</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">secsSince1900</span> <span class="o">=</span> <span class="n">highWord</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">lowWord</span><span class="p">;</span>  
    <span class="c1">// Unix time starts on Jan 1 1970. In seconds, that&#39;s 2208988800:</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seventyYears</span> <span class="o">=</span> <span class="mi">2208988800UL</span><span class="p">;</span>     
    <span class="c1">// subtract seventy years:</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">epoch</span> <span class="o">=</span> <span class="n">secsSince1900</span> <span class="o">-</span> <span class="n">seventyYears</span><span class="p">;</span>  
    <span class="c1">// return Unix time:</span>
    <span class="k">return</span> <span class="n">epoch</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// send an NTP request to the time server at the given address,</span>
<span class="c1">// necessary for getTime().</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sendNTPpacket</span><span class="p">(</span><span class="n">IPAddress</span><span class="o">&amp;</span> <span class="n">address</span><span class="p">){</span>
   
  <span class="c1">// set all bytes in the buffer to 0</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NTP_PACKET_SIZE</span><span class="p">);</span> 
  <span class="c1">// Initialize values needed to form NTP request</span>
  <span class="c1">// (see URL above for details on the packets)</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="n">b11100011</span><span class="p">;</span>   <span class="c1">// LI, Version, Mode</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">// Stratum, or type of clock</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>     <span class="c1">// Polling Interval</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xEC</span><span class="p">;</span>  <span class="c1">// Peer Clock Precision</span>
  <span class="c1">// 8 bytes of zero for Root Delay &amp; Root Dispersion</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">49</span><span class="p">;</span> 
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x4E</span><span class="p">;</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">49</span><span class="p">;</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">52</span><span class="p">;</span>
 
  <span class="c1">// all NTP fields have been given values, now</span>
  <span class="c1">// you can send a packet requesting a timestamp:         </span>
  <span class="n">Udp</span><span class="p">.</span><span class="n">beginPacket</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">123</span><span class="p">);</span> <span class="c1">//NTP requests are to port 123</span>
  <span class="n">Udp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span><span class="n">NTP_PACKET_SIZE</span><span class="p">);</span>
  <span class="n">Udp</span><span class="p">.</span><span class="n">endPacket</span><span class="p">();</span> 
<span class="p">}</span>
 
 
<span class="c1">// How big our line buffer should be for sending the files over the ethernet.</span>
<span class="c1">// 75 has worked fine for me so far.</span>
<span class="cp">#define BUFSIZ 75</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">millis</span><span class="p">()</span> <span class="o">%</span> <span class="n">lastIntervalTime</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MEASURE_INTERVAL</span><span class="p">){</span> <span class="c1">//Is it time for a new measurement?</span>
      
    <span class="kt">char</span> <span class="n">dataString</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rawTime</span><span class="p">;</span>
    <span class="n">rawTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>
 
    <span class="k">while</span><span class="p">((</span><span class="n">rawTime</span> <span class="o">==</span> <span class="mi">39</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)){</span>     <span class="c1">//server seems to send 39 as an error code</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>                              <span class="c1">//we want to retry if this happens. I chose</span>
      <span class="n">rawTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>                      <span class="c1">//12 retries because I&#39;m stubborn/persistent.</span>
      <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>                               <span class="c1">//NIST considers retry interval of &lt;4s as DoS</span>
    <span class="p">}</span>                                           <span class="c1">//attack, so fair warning.</span>
     
    <span class="k">if</span> <span class="p">(</span><span class="n">rawTime</span> <span class="o">!=</span> <span class="mi">39</span><span class="p">){</span>                         <span class="c1">//If that worked, and we have a real time</span>
       
      <span class="c1">//Decide if it&#39;s time to make a new file or not. Files are broken</span>
      <span class="c1">//up like this to keep loading times for each chart bearable.</span>
      <span class="c1">//Lots of string stuff happens to make a new filename if necessary.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">rawTime</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="p">.</span><span class="n">newFileTime</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">dayInt</span> <span class="o">=</span> <span class="n">day</span><span class="p">(</span><span class="n">rawTime</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">monthInt</span> <span class="o">=</span> <span class="n">month</span><span class="p">(</span><span class="n">rawTime</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">yearInt</span> <span class="o">=</span> <span class="n">year</span><span class="p">(</span><span class="n">rawTime</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">newFilename</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">dayStr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">monthStr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">yearStr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">subYear</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;data/&quot;</span><span class="p">);</span>
        <span class="n">itoa</span><span class="p">(</span><span class="n">dayInt</span><span class="p">,</span><span class="n">dayStr</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dayInt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">){</span>
          <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;0&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="n">dayStr</span><span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;-&quot;</span><span class="p">);</span>
        <span class="n">itoa</span><span class="p">(</span><span class="n">monthInt</span><span class="p">,</span><span class="n">monthStr</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">monthInt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">){</span>
          <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;0&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="n">monthStr</span><span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;-&quot;</span><span class="p">);</span>
        <span class="n">itoa</span><span class="p">(</span><span class="n">yearInt</span><span class="p">,</span><span class="n">yearStr</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
        <span class="c1">//we only want the last two digits of the year</span>
        <span class="n">memcpy</span><span class="p">(</span> <span class="n">subYear</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">yearStr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">3</span> <span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="n">subYear</span><span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;.csv&quot;</span><span class="p">);</span>
         
        <span class="c1">//make sure we update our config variables:</span>
        <span class="n">config</span><span class="p">.</span><span class="n">newFileTime</span> <span class="o">+=</span> <span class="n">FILE_INTERVAL</span><span class="p">;</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">workingFilename</span><span class="p">,</span><span class="n">newFilename</span><span class="p">);</span>
        <span class="c1">//Write the changes to EEPROM. Bad things may happen if power is lost midway through,</span>
        <span class="c1">//but it&#39;s a small risk we take. Manual fix with EEPROM_config sketch can correct it.</span>
        <span class="n">EEPROM_writeAnything</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span> 
      <span class="p">}</span>
         
      <span class="c1">//get the values and setup the string we want to write to the file</span>
      <span class="kt">int</span> <span class="n">sensor</span> <span class="o">=</span> <span class="n">analogRead</span><span class="p">(</span><span class="n">analogPin</span><span class="p">);</span>  
      <span class="kt">char</span> <span class="n">timeStr</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
      <span class="kt">char</span> <span class="n">sensorStr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
       
      <span class="n">ultoa</span><span class="p">(</span><span class="n">rawTime</span><span class="p">,</span><span class="n">timeStr</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span> 
      <span class="n">itoa</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span><span class="n">sensorStr</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
       
      <span class="n">strcat</span><span class="p">(</span><span class="n">dataString</span><span class="p">,</span><span class="n">timeStr</span><span class="p">);</span>
      <span class="n">strcat</span><span class="p">(</span><span class="n">dataString</span><span class="p">,</span><span class="s">&quot;,&quot;</span><span class="p">);</span>
      <span class="n">strcat</span><span class="p">(</span><span class="n">dataString</span><span class="p">,</span><span class="n">sensorStr</span><span class="p">);</span>
       
      <span class="c1">//open the file we&#39;ll be writing to.</span>
      <span class="n">File</span> <span class="n">dataFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">workingFilename</span><span class="p">,</span> <span class="n">FILE_WRITE</span><span class="p">);</span>
   
      <span class="c1">// if the file is available, write to it:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">dataFile</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dataFile</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">dataString</span><span class="p">);</span>
        <span class="n">dataFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
        <span class="c1">// print to the serial port too:</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">dataString</span><span class="p">);</span>
      <span class="p">}</span>  
      <span class="c1">// if the file isn&#39;t open, pop up an error:</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Error opening datafile for writing&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t resolve a time from the Ntp Server.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//Update the time of the last measurment to the current timer value</span>
    <span class="n">lastIntervalTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="c1">//No measurements to be made, make sure the webserver is available for connections.</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="kt">char</span> <span class="n">clientline</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     
    <span class="n">EthernetClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">available</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// an http request ends with a blank line</span>
      <span class="n">boolean</span> <span class="n">current_line_is_blank</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
       
      <span class="c1">// reset the input buffer</span>
      <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       
      <span class="k">while</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
          <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
           
          <span class="c1">// If it isn&#39;t a new line, add the character to the buffer</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">clientline</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
            <span class="n">index</span><span class="o">++</span><span class="p">;</span>
            <span class="c1">// are we too big for the buffer? start tossing out data</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">BUFSIZ</span><span class="p">)</span> 
              <span class="n">index</span> <span class="o">=</span> <span class="n">BUFSIZ</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
             
            <span class="c1">// continue to read more data!</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
           
          <span class="c1">// got a \n or \r new line, which means the string is done</span>
          <span class="n">clientline</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
           
          <span class="c1">// Print it out for debugging</span>
          <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">clientline</span><span class="p">);</span>
           
          <span class="c1">// Look for substring such as a request to get the root file</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">clientline</span><span class="p">,</span> <span class="s">&quot;GET / &quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// send a standard http response header</span>
            <span class="n">HtmlHeaderOK</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
            <span class="c1">// print all the data files, use a helper to keep it clean</span>
            <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;&lt;h2&gt;View data for the week of (dd-mm-yy):&lt;/h2&gt;&quot;</span><span class="p">);</span>
            <span class="n">ListFiles</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">clientline</span><span class="p">,</span> <span class="s">&quot;GET /&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// this time no space after the /, so a sub-file!</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
             
            <span class="n">filename</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">clientline</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;?&quot;</span><span class="p">);</span> <span class="c1">// look after the &quot;GET /&quot; (5 chars) but before</span>
            <span class="c1">// the &quot;?&quot; if a data file has been specified. A little trick, look for the &quot; HTTP/1.1&quot;</span>
            <span class="c1">// string and turn the first character of the substring into a 0 to clear it out.</span>
            <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">clientline</span><span class="p">,</span> <span class="s">&quot; HTTP&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             
            <span class="c1">// print the file we want</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">FILE_READ</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">HtmlHeader404</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
             
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Opened!&quot;</span><span class="p">);</span>
                       
            <span class="n">HtmlHeaderOK</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
             
            <span class="kt">int16_t</span> <span class="n">c</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// uncomment the serial to debug (slow!)</span>
                <span class="c1">//Serial.print((char)c);</span>
                <span class="n">client</span><span class="p">.</span><span class="n">print</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span><span class="n">c</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">file</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// everything else is a 404</span>
            <span class="n">HtmlHeader404</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// give the web browser time to receive the data</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">client</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
</pre></div>
</div>
</div>
<div class="section" id="the-results">
<h2>The Results</h2>
<p><img alt="Fig.1" src="../../../_images/online-graph-results.jpg" />
<img alt="Fig.2" src="../../../_images/online-graph-results2.jpg" />
<img alt="Fig.3" src="../../../_images/online-graph-results3.jpg" /></p>
</div>
</div>


          </div>
          
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, RobotDyn.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/MEGA2560-EthernetW5500/en/Tutorials/Online-Graph-for-Sensor.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>