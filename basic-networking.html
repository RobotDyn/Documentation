<style>
  .highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #8f5902; font-style: italic } /* Comment */
.highlight .err { color: #a40000; border: 1px solid #ef2929 } /* Error */
.highlight .g { color: #000000 } /* Generic */
.highlight .k { color: #004461; font-weight: bold } /* Keyword */
.highlight .l { color: #000000 } /* Literal */
.highlight .n { color: #000000 } /* Name */
.highlight .o { color: #582800 } /* Operator */
.highlight .x { color: #000000 } /* Other */
.highlight .p { color: #000000; font-weight: bold } /* Punctuation */
.highlight .ch { color: #8f5902; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #8f5902; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #8f5902 } /* Comment.Preproc */
.highlight .cpf { color: #8f5902; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #8f5902; font-style: italic } /* Comment.Single */
.highlight .cs { color: #8f5902; font-style: italic } /* Comment.Special */
.highlight .gd { color: #a40000 } /* Generic.Deleted */
.highlight .ge { color: #000000; font-style: italic } /* Generic.Emph */
.highlight .gr { color: #ef2929 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #745334 } /* Generic.Prompt */
.highlight .gs { color: #000000; font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #a40000; font-weight: bold } /* Generic.Traceback */
.highlight .kc { color: #004461; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #004461; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #004461; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #004461; font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: #004461; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #004461; font-weight: bold } /* Keyword.Type */
.highlight .ld { color: #000000 } /* Literal.Date */
.highlight .m { color: #990000 } /* Literal.Number */
.highlight .s { color: #4e9a06 } /* Literal.String */
.highlight .na { color: #c4a000 } /* Name.Attribute */
.highlight .nb { color: #004461 } /* Name.Builtin */
.highlight .nc { color: #000000 } /* Name.Class */
.highlight .no { color: #000000 } /* Name.Constant */
.highlight .nd { color: #888888 } /* Name.Decorator */
.highlight .ni { color: #ce5c00 } /* Name.Entity */
.highlight .ne { color: #cc0000; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #000000 } /* Name.Function */
.highlight .nl { color: #f57900 } /* Name.Label */
.highlight .nn { color: #000000 } /* Name.Namespace */
.highlight .nx { color: #000000 } /* Name.Other */
.highlight .py { color: #000000 } /* Name.Property */
.highlight .nt { color: #004461; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #000000 } /* Name.Variable */
.highlight .ow { color: #004461; font-weight: bold } /* Operator.Word */
.highlight .w { color: #f8f8f8; text-decoration: underline } /* Text.Whitespace */
.highlight .mb { color: #990000 } /* Literal.Number.Bin */
.highlight .mf { color: #990000 } /* Literal.Number.Float */
.highlight .mh { color: #990000 } /* Literal.Number.Hex */
.highlight .mi { color: #990000 } /* Literal.Number.Integer */
.highlight .mo { color: #990000 } /* Literal.Number.Oct */
.highlight .sa { color: #4e9a06 } /* Literal.String.Affix */
.highlight .sb { color: #4e9a06 } /* Literal.String.Backtick */
.highlight .sc { color: #4e9a06 } /* Literal.String.Char */
.highlight .dl { color: #4e9a06 } /* Literal.String.Delimiter */
.highlight .sd { color: #8f5902; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #4e9a06 } /* Literal.String.Double */
.highlight .se { color: #4e9a06 } /* Literal.String.Escape */
.highlight .sh { color: #4e9a06 } /* Literal.String.Heredoc */
.highlight .si { color: #4e9a06 } /* Literal.String.Interpol */
.highlight .sx { color: #4e9a06 } /* Literal.String.Other */
.highlight .sr { color: #4e9a06 } /* Literal.String.Regex */
.highlight .s1 { color: #4e9a06 } /* Literal.String.Single */
.highlight .ss { color: #4e9a06 } /* Literal.String.Symbol */
.highlight .bp { color: #3465a4 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #000000 } /* Name.Function.Magic */
.highlight .vc { color: #000000 } /* Name.Variable.Class */
.highlight .vg { color: #000000 } /* Name.Variable.Global */
.highlight .vi { color: #000000 } /* Name.Variable.Instance */
.highlight .vm { color: #000000 } /* Name.Variable.Magic */
.highlight .il { color: #990000 } /* Literal.Number.Integer.Long */
</style>

            
  <div class="section" id="basic-networking-set-up-with-mega-2560-eth">
<h1>Basic Networking Set-up with Mega 2560 ETH<a class="headerlink" href="#basic-networking-set-up-with-mega-2560-eth" title="Permalink to this headline"> </a></h1>
<div class="section" id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this headline"> </a></h2>
<p><a class="reference external" href="#minimal-code-structure"><strong>Minimal code structure</strong></a></p>
<p><a class="reference external" href="#setting-up-ethernet-mac-address"><strong>Setting up MAC address</strong></a></p>
<p><a class="reference external" href="#hard-coding-the-mac-address-in-your-sketch">Hard-coding the MAC address in your sketch</a></p>
<p><a class="reference external" href="#generating-a-unique-mac-address">Generating a unique MAC address</a></p>
<p><a class="reference external" href="#storing-mac-address-in-eeprom">Storing MAC address in EEPROM</a></p>
<p><a class="reference external" href="#storing-mac-address-on-an-sd-card">Storing MAC address on an SD card</a></p>
<p><a class="reference external" href="#ip-address"><strong>IP address</strong></a></p>
<p>[IPv4 vs IPv6]|(#ipv4-vs-ipv6)</p>
<p><a class="reference external" href="#hard-coding-ip-address-into-the-sketch">Hard-coding IP address into the sketch</a></p>
<p><a class="reference external" href="#dynamic-ip-address-assignement">Dynamic IP address assignement</a></p>
</div>
<div class="section" id="minimal-code-structure">
<h2>Minimal code Structure<a class="headerlink" href="#minimal-code-structure" title="Permalink to this headline"> </a></h2>
<p>The minimal valid code to run on Mega 2560 ETH has the following structure:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// code that you put here will run exactly once, at startup</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// code that you put here will run repeatedly until power off or reset to run repeatedly:</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Every line that starts with “//” is ignored by the compiler, so you can put any descriptions and comments in the code where you need them.</p>
</div>
<div class="section" id="setting-up-a-mega-2560-eth-ethernet-mac-address">
<h2>Setting up a Mega 2560 ETH Ethernet MAC address<a class="headerlink" href="#setting-up-a-mega-2560-eth-ethernet-mac-address" title="Permalink to this headline"> </a></h2>
<p>Network devices require two identifying addresses to operate on an Ethernet network: an IP address and a MAC (hardware) address. These two addresses operate at different layers of the network, IP is being assigned by a router or (rarely) manually, by an administrator of the network, whereas MAC is usually assigned at the factory, by the device manufacturer.
Since you are the manufacturer of the device that you build using a Mega ETH, you need to take care of configuring the MAC address yourself to connect it to a network.</p>
<div class="section" id="hard-coding-the-mac-address-in-your-sketch">
<h3>Hard-coding the MAC address in your sketch<a class="headerlink" href="#hard-coding-the-mac-address-in-your-sketch" title="Permalink to this headline"> </a></h3>
<p>The simplest way is to just hard-code the MAC address into the sketch. For example, start the Arduino IDE, go to File / Examples / Ethernet / WebServer and check out the code starting at line 20:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>    <span class="c1">// Enter a MAC address and IP address for your controller below.</span>
    <span class="c1">// The IP address will be dependent on your local network:</span>
    <span class="n">byte</span> <span class="n">mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> 
      <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="mh">0xAF</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0xEB</span> <span class="p">};</span>
    <span class="n">IPAddress</span> <span class="nf">ip</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">101</span><span class="p">);</span>
</pre></div>
</div>
<p>Later in the sketch those values are used when the Ethernet connection is initialized:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>  <span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ip</span> <span class="p">);</span>
</pre></div>
</div>
<p>You can choose to specify the IP address as shown (this is the case where IP address is being assigned manually by an administrator), or just specify only the MAC address and  obtain the IP address via DHCP (to make the network router choose and assign an unused IP address to the device).
As you can see in the givenexample, a MAC address is a sequence of 6 2-byte hexadecimal values. Some parts of the address carry a special meaning: for instance, the first three bytes are called the Organisationally Unique Identifier (OUI) while the last three bytes represent the specific Network Interface Controller (NIC). Specific bits within the OUI are also used to signify different modes of operqation of the network device, such as unicast or multicast. The safest way is to set the first byte to “0xDE” as in the example and modify the rest of the address.</p>
</div>
<div class="section" id="generating-a-unique-mac-address">
<h3>Generating a unique MAC address<a class="headerlink" href="#generating-a-unique-mac-address" title="Permalink to this headline"> </a></h3>
<p>If you are going to deploy more than one Mega ETH to the same Ethernet network, hard-coding a MAC address into the sketch might not be the most convinient option, as you would have to change the sketch for every device and keep track of their values manually. The solution there is to generate a unique address from a random value, as the chances of you picking the same MAC address as some other device on your network is ridiculously small.</p>
</div>
<div class="section" id="storing-mac-address-in-eeprom">
<h3>Storing MAC address in EEPROM<a class="headerlink" href="#storing-mac-address-in-eeprom" title="Permalink to this headline"> </a></h3>
<p>If you’re deploying a number of Mega ETH-based devices on a local network you’ll want them to retain their MAC addressess when powerded down and back up.</p>
<p>You don’t what the MAC address of each node to change each time it is restarted, this can cause certain issues with DHCP and also having a persistent MAC address is useful for sending messages over the network to uniquely identify which node it came from.</p>
<p>The example below generates a random MAC address and stores it in EEPROM. The random MAC address is generated on first power up, on each subsequent start after that it is read back out of EEPROM to ensure it stays the same::</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>    
    <span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
    <span class="cp">#include</span> <span class="cpf">&lt;Ethernet.h&gt;</span><span class="cp"></span>
    <span class="cp">#include</span> <span class="cpf">&lt;EEPROM.h&gt;</span><span class="cp"></span>
    
    <span class="n">byte</span> <span class="n">mac</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
    <span class="kt">char</span> <span class="n">macstr</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
    
    <span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
      <span class="c1">// Random MAC address stored in EEPROM</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">EEPROM</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EEPROM</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">randomSeed</span><span class="p">(</span><span class="n">analogRead</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xde</span><span class="p">;</span>
        <span class="n">EEPROM</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
          <span class="n">EEPROM</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="n">EEPROM</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;#&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">snprintf</span><span class="p">(</span><span class="n">macstr</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="s">&quot;%02x:%02x:%02x:%02x:%02x:%02x&quot;</span><span class="p">,</span> <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mac</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mac</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mac</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mac</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
    
      <span class="c1">// Start up networking</span>
      <span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
    
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span>
    <span class="p">}</span>
    
    <span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>The only thing to watch out for is if you are using EEPROM elsewhere in your sketch that you don’t rewrite the values with some other stuff.</p>
</div>
<div class="section" id="storing-mac-address-on-an-sd-card">
<h3>Storing MAC address on an SD card<a class="headerlink" href="#storing-mac-address-on-an-sd-card" title="Permalink to this headline"> </a></h3>
<p>The SD library is used to read from / write to an SD card using the built-in Mega ETH Card Reader. The library supports:</p>
<ul class="simple">
<li>FAT32 and FAT16 file systems;</li>
<li>standard and high-capacity SD cards;</li>
<li>8.3 short filenames only.</li>
</ul>
<p>The file names used with the SD library functions can include paths where directory names are separated by forward-slashes, “/”, e.g. “dirname/filename.txt”.</p>
<p>The microcontroller communicates to the SD card over SPI bus using pins 50, 51, and 52. Another pin must be used to select the SD card, this can be pin 53 or any other pin specified in the call to SD.begin(), it must be configured as output (even if not used), otherwise the SD library won’t work.
Let’s change the last example to write the MAC address to an SD card file “mac.dat” instead of EEPROM::</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>    
    <span class="cm">/*</span>
<span class="cm">      </span>
<span class="cm">      The circuit:</span>
<span class="cm">       SD card attached to SPI bus as follows:</span>
<span class="cm">    </span>
<span class="cm">      * MOSI - pin 11</span>
<span class="cm">      * MISO - pin 12</span>
<span class="cm">      * CLK - pin 13</span>
<span class="cm">      * CS - pin 4 </span>
<span class="cm">    </span>
<span class="cm">    */</span>
    
    <span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
    <span class="cp">#include</span> <span class="cpf">&lt;SD.h&gt;</span><span class="cp"></span>
    <span class="cp">#include</span> <span class="cpf">&lt;Ethernet.h&gt;</span><span class="cp"></span>
    
    <span class="k">const</span> <span class="kt">int</span> <span class="n">chipSelect</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">byte</span> <span class="n">mac</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
    
    <span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Open serial communications and wait for port to open:</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">Serial</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">;</span> <span class="c1">// wait for serial port to connect. Needed for native USB port only</span>
      <span class="p">}</span>
    
    
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Initializing SD card...&quot;</span><span class="p">);</span>
    
      <span class="c1">// see if the card is present and can be initialized:</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SD</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">chipSelect</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Card failed, or not present&quot;</span><span class="p">);</span>
        <span class="c1">// don&#39;t do anything more:</span>
        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;card initialized.&quot;</span><span class="p">);</span>
    
      <span class="c1">// open the file.</span>
    
      <span class="n">File</span> <span class="n">dataFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;mac.dat&quot;</span><span class="p">);</span>
    
      <span class="c1">// if the file is available, write to it:</span>
    
      <span class="k">if</span> <span class="p">(</span><span class="n">dataFile</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataFile</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    
        <span class="c1">// if not – create mac.dat, generate a random MAC</span>
        <span class="c1">// (first byte = 0xDE)</span>
        <span class="c1">// and store it to mac.dat</span>
    
        <span class="n">dataFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;mac.dat&quot;</span><span class="p">,</span> <span class="n">FILE_WRITE</span><span class="p">);</span>
        <span class="n">randomSeed</span><span class="p">(</span><span class="n">analogRead</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xde</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">dataFile</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
        <span class="n">dataFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="c1">// Start up networking</span>
      <span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
    
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span>
    <span class="p">}</span>
    
    <span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ip-address">
<h2>IP address<a class="headerlink" href="#ip-address" title="Permalink to this headline"> </a></h2>
<p>IP address is a numerical identifier assigned to each device that is connected to a network that uses Internet Protocol for communication. An IP address can be assigned either manually, by a network administrator, or automatically by a network router or a similar device. The former is called “static IP address setup”, the latter is called “dynamic” or DHCP setup, since it uses the DHCP protocol for the IP address quereries and assignements.</p>
<div class="section" id="ipv4-vs-ipv6">
<h3>IPv4 vs IPv6<a class="headerlink" href="#ipv4-vs-ipv6" title="Permalink to this headline"> </a></h3>
<p>There are 2 version of the IP protocol and addresses: IPv4 and, newer, IPv6. IPv4 defines an IP address as a 32-bit integer number denoted as 4 0-255 values separated with “.”, e.g.: 192.168.0.1
Because of the depletion of the IPv4 IP address space the newer IPv6 protocol uses 128-bit addresses, denoted as 6 16-bit hexadecimal numbers (0x0 - 0xFFFF) separated by “:”, e.g.: 2001:db8:0:1234:0:567:8:1
The standard Arduino networking libraries (Ethernet3, Ethernet4) support IPv4 only. The W5500 chip itself supports only IPv4 natively, however there is a low-level MACRAW mode for sending Ehternet frames directly and there are some alternative networking libraries (e.g. <a class="reference external" href="https://github.com/njh/ethersia">Ethersia</a>)with IPv6 support built-in.</p>
</div>
<div class="section" id="hard-coding-ip-address-into-the-sketch">
<h3>Hard-coding IP address into the sketch<a class="headerlink" href="#hard-coding-ip-address-into-the-sketch" title="Permalink to this headline"> </a></h3>
<p>The simplest way to assign an IP address to your Mega ETH-based device is to hard-code the IP address into the sketch:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span>   
    <span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
    <span class="cp">#include</span> <span class="cpf">&lt;Ethernet3.h&gt;</span><span class="cp"></span>

    <span class="c1">// network configuration. dns server, gateway and subnet are optional.</span>

     <span class="c1">// the media access control (ethernet hardware) address:</span>
    <span class="n">byte</span> <span class="n">mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xAD</span><span class="p">,</span> <span class="mh">0xBE</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0xED</span> <span class="p">};</span>  

    <span class="c1">// the dns server ip</span>
    <span class="n">IPAddress</span> <span class="nf">dnServer</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="c1">// the router&#39;s gateway address:</span>
    <span class="n">IPAddress</span> <span class="nf">gateway</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="c1">// the subnet:</span>
    <span class="n">IPAddress</span> <span class="nf">subnet</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">//the IP address is dependent on your network</span>
    <span class="n">IPAddress</span> <span class="nf">ip</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>

      <span class="c1">// initialize the ethernet device</span>
      <span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dnServer</span><span class="p">,</span> <span class="n">gateway</span><span class="p">,</span> <span class="n">subnet</span><span class="p">);</span>
      <span class="c1">//print out the IP address</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;IP = &quot;</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="dynamic-ip-address-assignement">
<h3>Dynamic IP address assignement<a class="headerlink" href="#dynamic-ip-address-assignement" title="Permalink to this headline"> </a></h3>
<p>If you are going to connect several Mega ETH devices to the same network segment, hard-coding an IP address might not be very convinient, since you don’t want to change the sketch for every device you deploy. In this case and in all cases where DHCP service is available on the network, it would be much better to automatically obtain an IP address from the DHCP server and store it in non-volatile memory, EEPROM or SD card, because, in most cases, it is desirable for a network device to retain it’s assigned IP address every time it is powered up.
In the following example Mega ETH will obtain an IP address via DHCP protocol using the <a class="reference external" href="https://github.com/sstaub/Ethernet3">Ethernet3 library</a> and display it on a 16x24 LCD monitor:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>  
    <span class="cm">/*</span>

<span class="cm">      This sketch uses the DHCP to get an IP address</span>
<span class="cm">      and display the address on an LCD.</span>

<span class="cm">     */</span>

    <span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
    <span class="cp">#include</span> <span class="cpf">&lt;Ethernet3.h&gt;</span><span class="cp"></span>
    <span class="cp">#include</span> <span class="cpf">&lt;LiquidCrystal.h&gt;</span><span class="cp"></span>

    <span class="c1">// Enter a MAC address for your controller below.</span>

    <span class="n">byte</span> <span class="n">mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0xAB</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0xEF</span><span class="p">,</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0x02</span>
    <span class="p">};</span>
    <span class="c1">// initialize the LCD library with the numbers of the interface pins</span>
    <span class="n">LiquidCrystal</span> <span class="nf">lcd</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

    <span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
     
      
      <span class="n">lcd</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">linkStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">LinkOFF</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">lcd</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;LINK FAILURE&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="n">lcd</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;DHCP ERROR!&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="c1">// success, display your local IP address:</span>
             <span class="n">lcd</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span>

        <span class="c1">// do nothing more:</span>
      <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>

