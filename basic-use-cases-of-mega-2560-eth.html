
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Basic Use-Cases of Mega 2560 ETH &#8212; RobotDyn  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="basic-use-cases-of-mega-2560-eth">
<h1>Basic Use-Cases of Mega 2560 ETH</h1>
<div class="section" id="table-of-contents">
<h2>Table of Contents</h2>
<p><a class="reference external" href="#data-logger-with-mysql"><strong>Data Logger with MySQL</strong></a></p>
<p><a class="reference external" href="#the-hardware">Hardware</a></p>
<p><a class="reference external" href="#the-software">The Software</a></p>
<p><a class="reference external" href="#ftp-server-using-sd-card"><strong>FTP Server using SD Card</strong></a></p>
<p><a class="reference external" href="#relay-shield-example"><strong>Relay Shield Example</strong></a></p>
<p><a class="reference external" href="#schematics">Schematics</a></p>
<p><a class="reference external" href="#code">Code</a></p>
<p><a class="reference external" href="#online-graph-using-mega-2560-eth-web-server-with-no-external-services"><strong>Online Graph Using Mega 2560 ETH Web Server with No External Services</strong></a></p>
<p><a class="reference external" href="#connecting-a-sensor">Connecting a Sensor</a></p>
<p><a class="reference external" href="#preparing-the-web-page-on-sd-card">Preparing the Web Page on SD Card</a></p>
<p><a class="reference external" href="#preparing-the-sketch">Preparing the sketch</a></p>
<p><a class="reference external" href="#the-main-sketch">The main sketch</a></p>
<p><a class="reference external" href="#the-results">The Results</a></p>
<p><a class="reference external" href="#web-server"><strong>Web Server</strong></a></p>
<p>[Creating the Web Page](#Creating the Web Page)</p>
<p><a class="reference external" href="#preparing-the-web-server-sketch">Preparing the Web-Server Sketch</a></p>
<p><a class="reference external" href="#saving-temperature-sensor-data-to-google-docs"><strong>Saving Temperature Sensor Data to Google Docs</strong></a></p>
<p><a class="reference external" href="#get-accounts">Get Accounts</a></p>
<p><a class="reference external" href="#create-a-google-form-and-get-form-key">Create a Google Form and Get FORM KEY</a></p>
<p><a class="reference external" href="#pushingbox-service-and-scenarios">Pushingbox, Service and Scenarios</a></p>
<p><a class="reference external" href="#sketch-for-the-mega-eth">Sketch for the Mega ETH</a></p>
</div>
<div class="section" id="data-logger-with-mysql">
<h2>Data Logger with MySQL</h2>
<p>In this example we will build a simple temperature data logger that will send data to a remote MySQL database. Every measurement will be accompanied with a corresponding timestamp, hence we’ll need a sensor module and a real time clock module</p>
<div class="section" id="the-hardware">
<h3>The Hardware</h3>
<ol class="simple">
<li>Mega ETH board</li>
<li>DHT11 temperature/humidity sensor</li>
<li>RTC (Real Time Clock) DS1307 module</li>
<li>one breadboard</li>
<li>connecting wires</li>
</ol>
<p>The RTC modules’ I2C pins SDA and SCL, DHT11 - to pins 7 and 8 of the Mega ETH board.</p>
</div>
</div>
<div class="section" id="the-software">
<h2>The Software</h2>
<p>First we need to set up a MySQL database server. Let’s assume that we install it on a computer with an ip address of 192.168.1.33 on our local network and create a database <code class="docutils literal notranslate"><span class="pre">robologger</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">database</span> <span class="n">robologger</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="k">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">robologger</span><span class="p">;</span>
<span class="k">database</span> <span class="n">changed</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">create</span> <span class="k">table</span> <span class="n">sensdata</span> <span class="p">(</span><span class="n">id</span> <span class="nb">float</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span> <span class="n">auto_increment</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> <span class="nb">date</span> <span class="nb">date</span><span class="p">,</span> <span class="n">time</span> <span class="n">time</span><span class="p">,</span> <span class="n">temp</span> <span class="nb">float</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">humi</span> <span class="nb">float</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">);</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">sensdata</span> <span class="p">(</span><span class="nb">date</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">humi</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">&#39;2019-11-10&#39;</span><span class="p">,</span><span class="s1">&#39;14:11:00&#39;</span><span class="p">,</span> <span class="mi">32</span><span class="p">.</span><span class="mi">4</span><span class="p">,</span> <span class="mi">97</span><span class="p">.</span><span class="mi">8</span><span class="p">);</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="k">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<p>Next we will grant access to the user robotdyn to this database:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">grant</span> <span class="k">all</span> <span class="k">privileges</span> <span class="k">ON</span> <span class="n">robologger</span><span class="p">.</span><span class="o">*</span> <span class="k">to</span> <span class="s1">&#39;robotdyn&#39;</span><span class="o">@</span><span class="s1">&#39;192.168.1.%&#39;</span> <span class="n">identified</span> <span class="k">by</span> <span class="s1">&#39;robotdyn&#39;</span> <span class="k">with</span> <span class="k">grant</span> <span class="k">option</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">flush</span> <span class="k">privileges</span><span class="p">;</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="k">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">quit</span><span class="p">;</span>
</pre></div>
</div>
<p>Now, in our sketch we will need to connect to the Internet and set the RTC using NTP protocol. Then, using the Real Time Clock and every 10 minutes we log time, sensor data and send it to the database.</p>
<p>We will need an updated <a class="reference external" href="http://www.pjrc.com/teensy/td_libs_Time.html">Time library</a>. Download and extract it to your project folder.</p>
<p>For DHT11 we will use <a class="reference external" href="https://github.com/practicalarduino/SHT1x">this library</a>
Please rename the extracted SHT1x-master to SHT1xmaster.</p>
<p>Then, we will need the MySQL connector libraries from <a class="reference external" href="https://launchpad.net/mysql-arduino">https://launchpad.net/mysql-arduino</a>.</p>
<p>In mysql.h uncomment the line:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#define WITH_SELECT </span><span class="c1">// Uncomment this for use without SELECT capability</span>
</pre></div>
</div>
<p>Try compiling the code. You can find additional info on the use of MySQL connector on <a class="reference external" href="http://drcharlesbell.blogspot.ro/2013/04/introducing-mysql-connectorarduino_6.html">Chuck’s blog</a>.</p>
<p>The code:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Ethernet.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Dns.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Wire.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;DS1307RTC.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;SHT1x.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sha1.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mysql.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="cm">/* ******** Ethernet Card Settings ******** */</span>
<span class="c1">// Set this to your Ethernet Card Mac Address</span>
<span class="n">byte</span> <span class="n">mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0xFE</span><span class="p">,</span> <span class="mh">0x43</span> <span class="p">};</span>

<span class="cm">/* ******** NTP Server Settings ******** */</span>
<span class="cm">/* us.pool.ntp.org NTP server</span>
<span class="cm">(Set to your time server of choice) */</span>
<span class="n">IPAddress</span> <span class="n">timeServer</span><span class="p">;</span>

<span class="cm">/* Set this to the offset (in seconds) to your local time</span>
<span class="cm">This example is GMT + 2 */</span>
<span class="k">const</span> <span class="kt">long</span> <span class="n">timeZoneOffset</span> <span class="o">=</span> <span class="mi">7200L</span><span class="p">;</span>

<span class="cm">/* Syncs to NTP server every 15 seconds for testing,</span>
<span class="cm">   set to 1 hour or more to be reasonable */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ntpSyncTime</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>        

<span class="cm">/* ALTER THESE VARIABLES AT YOUR OWN RISK */</span>
<span class="c1">// local port to listen for UDP packets</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">localPort</span> <span class="o">=</span> <span class="mi">8888</span><span class="p">;</span>
<span class="c1">// NTP time stamp is in the first 48 bytes of the message</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">NTP_PACKET_SIZE</span><span class="o">=</span> <span class="mi">48</span><span class="p">;</span>      
<span class="c1">// Buffer to hold incoming and outgoing packets</span>
<span class="n">byte</span> <span class="n">packetBuffer</span><span class="p">[</span><span class="n">NTP_PACKET_SIZE</span><span class="p">];</span>  
<span class="c1">// A UDP instance to let us send and receive packets over UDP</span>
<span class="n">EthernetUDP</span> <span class="n">Udp</span><span class="p">;</span>                    
       

<span class="cm">/* ********** RTC Time settings ********* */</span>
<span class="n">tmElements_t</span> <span class="n">tm</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">minutes_now</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">minutes_next</span><span class="p">;</span>

<span class="cm">/* ******* Settings for the SHT1x sensor  */</span>
<span class="cp">#define dataPin  9</span>
<span class="cp">#define clockPin 8</span>
<span class="n">SHT1x</span> <span class="nf">sht1x</span><span class="p">(</span><span class="n">dataPin</span><span class="p">,</span> <span class="n">clockPin</span><span class="p">);</span>
<span class="kt">float</span> <span class="n">temp_c</span><span class="p">;</span>
<span class="kt">float</span> <span class="n">humidity</span><span class="p">;</span>

<span class="cm">/* ***** MySQl Server settings ********** */</span>
<span class="n">Connector</span> <span class="n">my_conn</span><span class="p">;</span>        <span class="c1">// The Connector/Arduino reference</span>
<span class="n">IPAddress</span> <span class="nf">server_addr</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">133</span><span class="p">);</span>  <span class="c1">// IP address of MySQL server</span>
<span class="kt">char</span> <span class="n">user</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;robotdyn&quot;</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">password</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;robotdyn&quot;</span><span class="p">;</span>
<span class="c1">// maximum tries to connect</span>
<span class="kt">int</span> <span class="n">num_fails</span><span class="p">;</span>
<span class="cp">#define MAX_FAILED_CONNECTS 5</span>
<span class="c1">// We define some strings</span>
<span class="kt">char</span> <span class="n">myquery</span><span class="p">[</span><span class="mi">150</span><span class="p">];</span>  <span class="c1">// more than enough; stores command to print table content</span>
<span class="kt">char</span> <span class="n">insquery</span><span class="p">[</span><span class="mi">200</span><span class="p">];</span> <span class="c1">// more than enough; stores command to insert new data</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">testselect</span><span class="p">[]</span> <span class="o">=</span><span class="p">{</span><span class="s">&quot;SELECT * FROM robologger.robodata ORDER BY id DESC LIMIT %s&quot;</span><span class="p">};</span>
<span class="c1">// general format to insert data is:</span>
<span class="c1">//const char insertdata[] = &quot;INSERT INTO ardulogger.ardudata (date,time,temp,humi) VALUES (&#39;2014-11-11&#39;,&#39;11:45:11&#39;, 25.8 , 31.21)&quot;;</span>
<span class="c1">//const char insertdata[] = {&quot;INSERT INTO ardulogger.ardudata (date,time,temp,humi) VALUES (&#39;%s-%s-%s&#39;,&#39;%s:%s:%s&#39;, %s , %s)&quot;};</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">insertdata</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;INSERT INTO robologger.robodata (date,time,temp,humi) VALUES (&#39;%s-%s-%s&#39;,&#39;%s:%s:%s&#39;, %s , %s)&quot;</span><span class="p">};</span>
<span class="c1">// buffer for number to character conversion</span>
<span class="kt">char</span> <span class="n">yearbuf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">monthbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">daybuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">hourbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">minutebuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="n">String</span> <span class="n">temp_buf</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">secbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">tempbuf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">humibuf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">timebuf</span><span class="p">;</span>

 
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
   
   <span class="c1">// Ethernet shield and NTP setup</span>
   <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">DHCP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">DHCP</span> <span class="o">=</span> <span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
   <span class="c1">//Try to get dhcp settings 30 times before giving up</span>
   <span class="k">while</span><span class="p">(</span> <span class="n">DHCP</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">){</span>
     <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
     <span class="n">DHCP</span> <span class="o">=</span> <span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
     <span class="n">i</span><span class="o">++</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">DHCP</span><span class="p">){</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;DHCP FAILED&quot;</span><span class="p">);</span>
     <span class="k">for</span><span class="p">(;;);</span> <span class="c1">//Infinite loop because DHCP Failed</span>
   <span class="p">}</span>
   <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;DHCP Success&quot;</span><span class="p">);</span>  
 
   <span class="c1">//Just for testing we print the obtained IP address  </span>
   <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;My IP address: &quot;</span><span class="p">);</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">byte</span> <span class="n">thisByte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">thisByte</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">thisByte</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// print the value of each byte of the IP address:</span>
   <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">localIP</span><span class="p">()[</span><span class="n">thisByte</span><span class="p">],</span> <span class="n">DEC</span><span class="p">);</span>
   <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
 
  <span class="c1">// We get the address of a NTP server from NTP pool</span>
  <span class="n">DNSClient</span> <span class="n">dns</span><span class="p">;</span>
  <span class="n">dns</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">dnsServerIP</span><span class="p">());</span>
  <span class="n">dns</span><span class="p">.</span><span class="n">getHostByName</span><span class="p">(</span><span class="s">&quot;ro.pool.ntp.org&quot;</span><span class="p">,</span><span class="n">timeServer</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;NTP IP from the pool: &quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">timeServer</span><span class="p">);</span>
 
  <span class="c1">// Now we get the time</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;trying to get the time&quot;</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">trys</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">getTimeAndDate</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">trys</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">){</span>
        <span class="n">trys</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span><span class="p">(</span><span class="n">trys</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">){</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Ntp server update success&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span><span class="p">{</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Ntp server update failed&quot;</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="c1">// Print the time</span>
  <span class="n">clockDisplay</span><span class="p">();</span>
 
  <span class="c1">// We have the right time, now we set the RTC clock</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">RTC</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">tm</span><span class="p">))</span> <span class="p">{</span>
       <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;The DS1307 is running.&quot;</span><span class="p">);</span>
       <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Updating the RTC time.&quot;</span><span class="p">);</span>
       <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Day</span> <span class="o">=</span> <span class="n">day</span><span class="p">();</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Month</span> <span class="o">=</span> <span class="n">month</span><span class="p">();</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Year</span> <span class="o">=</span> <span class="n">year</span><span class="p">()</span><span class="o">-</span><span class="mi">1970</span><span class="p">;</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Hour</span> <span class="o">=</span> <span class="n">hour</span><span class="p">();</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Minute</span> <span class="o">=</span> <span class="n">minute</span><span class="p">();</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Second</span> <span class="o">=</span> <span class="n">second</span><span class="p">();</span>
       <span class="n">RTC</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">tm</span><span class="p">);</span>   <span class="c1">//update the time</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">RTC</span><span class="p">.</span><span class="n">chipPresent</span><span class="p">())</span> <span class="p">{</span>
       <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;The RTC stopped.&quot;</span><span class="p">);</span>
       <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Setting the RTC time.&quot;</span><span class="p">);</span>
       <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Day</span> <span class="o">=</span> <span class="n">day</span><span class="p">();</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Month</span> <span class="o">=</span> <span class="n">month</span><span class="p">();</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Year</span> <span class="o">=</span> <span class="n">year</span><span class="p">()</span><span class="o">-</span><span class="mi">1970</span><span class="p">;</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Hour</span> <span class="o">=</span> <span class="n">hour</span><span class="p">();</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Minute</span> <span class="o">=</span> <span class="n">minute</span><span class="p">();</span>
       <span class="n">tm</span><span class="p">.</span><span class="n">Second</span> <span class="o">=</span> <span class="n">second</span><span class="p">();</span>
       <span class="n">RTC</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">tm</span><span class="p">);</span>   <span class="c1">//update the time</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="p">{</span>
       <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;RTC read error!  Please check the circuitry.&quot;</span><span class="p">);</span>
       <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="c1">// Just in case we read the RTC time for debugging purposes</span>
   <span class="c1">// Serial.println(&quot;Computing the next DB access time&quot;);</span>
    <span class="n">RTC</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">tm</span><span class="p">);</span>
    <span class="n">minutes_now</span><span class="o">=</span><span class="n">tm</span><span class="p">.</span><span class="n">Minute</span><span class="p">;</span>
   <span class="c1">// minutes_next=floor(tm.Minute/10)*10+10;</span>
    <span class="n">minutes_next</span><span class="o">=</span><span class="n">minutes_now</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//debugging - write every minute to DB</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">minutes_next</span><span class="o">==</span><span class="mi">60</span><span class="p">)</span>
      <span class="n">minutes_next</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Current minute: &quot;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">minutes_now</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Minute for the next database write: &quot;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">minutes_next</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>

<span class="p">}</span> <span class="c1">//end of setup</span>

<span class="c1">// functions for NTP server</span>
<span class="c1">// Do not alter this function, it is used by the system</span>
<span class="kt">int</span> <span class="nf">getTimeAndDate</span><span class="p">()</span> <span class="p">{</span>
   <span class="kt">int</span> <span class="n">flag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
   <span class="n">Udp</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">localPort</span><span class="p">);</span>
   <span class="n">sendNTPpacket</span><span class="p">(</span><span class="n">timeServer</span><span class="p">);</span>
   <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">Udp</span><span class="p">.</span><span class="n">parsePacket</span><span class="p">()){</span>
     <span class="n">Udp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span><span class="n">NTP_PACKET_SIZE</span><span class="p">);</span>  <span class="c1">// read the packet into the buffer</span>
     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">highWord</span><span class="p">,</span> <span class="n">lowWord</span><span class="p">,</span> <span class="n">epoch</span><span class="p">;</span>
     <span class="n">highWord</span> <span class="o">=</span> <span class="n">word</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">[</span><span class="mi">40</span><span class="p">],</span> <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">41</span><span class="p">]);</span>
     <span class="n">lowWord</span> <span class="o">=</span> <span class="n">word</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">[</span><span class="mi">42</span><span class="p">],</span> <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">43</span><span class="p">]);</span>  
     <span class="n">epoch</span> <span class="o">=</span> <span class="n">highWord</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">lowWord</span><span class="p">;</span>
     <span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">-</span> <span class="mi">2208988800</span> <span class="o">+</span> <span class="n">timeZoneOffset</span><span class="p">;</span>
     <span class="n">flag</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
     <span class="n">setTime</span><span class="p">(</span><span class="n">epoch</span><span class="p">);</span>
     <span class="c1">//ntpLastUpdate = now();  not needed anymore as we update the time only once</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="c1">// Do not alter this function, it is used by the system</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sendNTPpacket</span><span class="p">(</span><span class="n">IPAddress</span><span class="o">&amp;</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NTP_PACKET_SIZE</span><span class="p">);</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="n">b11100011</span><span class="p">;</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xEC</span><span class="p">;</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">49</span><span class="p">;</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x4E</span><span class="p">;</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">49</span><span class="p">;</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">52</span><span class="p">;</span>                  
  <span class="n">Udp</span><span class="p">.</span><span class="n">beginPacket</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">123</span><span class="p">);</span>
  <span class="n">Udp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span><span class="n">NTP_PACKET_SIZE</span><span class="p">);</span>
  <span class="n">Udp</span><span class="p">.</span><span class="n">endPacket</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Clock display of the time and date (Basic)</span>
<span class="kt">void</span> <span class="nf">clockDisplay</span><span class="p">(){</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">hour</span><span class="p">());</span>
  <span class="n">printDigits</span><span class="p">(</span><span class="n">minute</span><span class="p">());</span>
  <span class="n">printDigits</span><span class="p">(</span><span class="n">second</span><span class="p">());</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">day</span><span class="p">());</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">month</span><span class="p">());</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">year</span><span class="p">());</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="c1">// Utility function for clock display: prints preceding colon and leading 0</span>
<span class="kt">void</span> <span class="nf">printDigits</span><span class="p">(</span><span class="kt">int</span> <span class="n">digits</span><span class="p">){</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="n">digits</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">digits</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">// End of NTP functions</span>

<span class="kt">void</span> <span class="nf">print2digits</span><span class="p">(</span><span class="kt">int</span> <span class="n">number</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">number</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">number</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">(){</span>
 
    <span class="n">RTC</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">tm</span><span class="p">);</span>
    <span class="n">minutes_now</span><span class="o">=</span><span class="n">tm</span><span class="p">.</span><span class="n">Minute</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">minutes_now</span><span class="o">==</span><span class="n">minutes_next</span><span class="p">){</span>
    <span class="c1">//if (time_now.Minute==minutes_next){  </span>
       <span class="c1">// compute the next time for write</span>
       <span class="c1">//minutes_next=floor(tm.Minute/10)*10+10; // write every 10 minutes - normal mode</span>
       <span class="n">minutes_next</span><span class="o">=</span><span class="n">minutes_now</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// write every minute - debug mode</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">minutes_next</span><span class="o">==</span><span class="mi">60</span><span class="p">)</span>
       <span class="n">minutes_next</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
       <span class="n">temp_c</span> <span class="o">=</span> <span class="n">sht1x</span><span class="p">.</span><span class="n">readTemperatureC</span><span class="p">();</span>
       <span class="n">humidity</span> <span class="o">=</span> <span class="n">sht1x</span><span class="p">.</span><span class="n">readHumidity</span><span class="p">();</span>
       <span class="c1">// we construct the INSERT code here</span>
       <span class="c1">// first we initialize the buffers</span>
       <span class="n">temp_buf</span><span class="o">=</span><span class="n">String</span><span class="p">(</span><span class="n">tm</span><span class="p">.</span><span class="n">Year</span><span class="o">+</span><span class="mi">1970</span><span class="p">);</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">trim</span><span class="p">();</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">toCharArray</span><span class="p">(</span><span class="n">yearbuf</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
       <span class="n">temp_buf</span><span class="o">=</span><span class="n">String</span><span class="p">(</span><span class="n">tm</span><span class="p">.</span><span class="n">Month</span><span class="p">);</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">trim</span><span class="p">();</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">toCharArray</span><span class="p">(</span><span class="n">monthbuf</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
       <span class="n">temp_buf</span><span class="o">=</span><span class="n">String</span><span class="p">(</span><span class="n">tm</span><span class="p">.</span><span class="n">Day</span><span class="p">);</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">trim</span><span class="p">();</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">toCharArray</span><span class="p">(</span><span class="n">daybuf</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
       <span class="n">temp_buf</span><span class="o">=</span><span class="n">String</span><span class="p">(</span><span class="n">tm</span><span class="p">.</span><span class="n">Hour</span><span class="p">);</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">trim</span><span class="p">();</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">toCharArray</span><span class="p">(</span><span class="n">hourbuf</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
       <span class="n">temp_buf</span><span class="o">=</span><span class="n">String</span><span class="p">(</span><span class="n">tm</span><span class="p">.</span><span class="n">Minute</span><span class="p">);</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">trim</span><span class="p">();</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">toCharArray</span><span class="p">(</span><span class="n">minutebuf</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
       <span class="n">temp_buf</span><span class="o">=</span><span class="n">String</span><span class="p">(</span><span class="n">tm</span><span class="p">.</span><span class="n">Second</span><span class="p">);</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">trim</span><span class="p">();</span>
       <span class="n">temp_buf</span><span class="p">.</span><span class="n">toCharArray</span><span class="p">(</span><span class="n">secbuf</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
       <span class="c1">//  float to char conversion</span>
       <span class="n">dtostrf</span><span class="p">(</span><span class="n">temp_c</span><span class="p">,</span> <span class="mi">5</span> <span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tempbuf</span><span class="p">);</span>
       <span class="n">dtostrf</span><span class="p">(</span><span class="n">humidity</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">humibuf</span><span class="p">);</span>
       <span class="c1">// now we build the command for data insertion</span>
       <span class="n">sprintf</span><span class="p">(</span><span class="n">insquery</span><span class="p">,</span><span class="n">insertdata</span><span class="p">,</span><span class="n">yearbuf</span><span class="p">,</span><span class="n">monthbuf</span><span class="p">,</span><span class="n">daybuf</span><span class="p">,</span><span class="n">hourbuf</span><span class="p">,</span><span class="n">minutebuf</span><span class="p">,</span><span class="n">secbuf</span><span class="p">,</span><span class="n">tempbuf</span><span class="p">,</span><span class="n">humibuf</span><span class="p">);</span>
       <span class="c1">//ready to work with the database</span>
       <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;DB write: &quot;</span><span class="p">);</span>
       <span class="c1">// Here comes the MySQL data code</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">my_conn</span><span class="p">.</span><span class="n">mysql_connect</span><span class="p">(</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">3306</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span>  <span class="p">{</span>
          <span class="c1">// check for connection</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">my_conn</span><span class="p">.</span><span class="n">is_connected</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Last 5 DB entries!&quot;</span><span class="p">);</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span><span class="n">testselect</span><span class="p">,</span><span class="s">&quot;5&quot;</span><span class="p">);</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">myquery</span><span class="p">);</span>
            <span class="n">my_conn</span><span class="p">.</span><span class="n">cmd_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">);</span>
            <span class="n">delay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span> <span class="c1">// small delay to wait for MySQl server to respond</span>
            <span class="n">my_conn</span><span class="p">.</span><span class="n">show_results</span><span class="p">();</span>
            <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Inserting new data!&quot;</span><span class="p">);</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">insquery</span><span class="p">);</span>
            <span class="n">my_conn</span><span class="p">.</span><span class="n">cmd_query</span><span class="p">(</span><span class="n">insquery</span><span class="p">);</span>
            <span class="n">delay</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span> <span class="c1">// small delay to wait for MySQl server to respond</span>
            <span class="c1">// We verify the last entered data</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;New data entered!&quot;</span><span class="p">);</span>
            <span class="n">sprintf</span><span class="p">(</span><span class="n">myquery</span><span class="p">,</span><span class="n">testselect</span><span class="p">,</span><span class="s">&quot;1&quot;</span><span class="p">);</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">myquery</span><span class="p">);</span>
            <span class="n">my_conn</span><span class="p">.</span><span class="n">cmd_query</span><span class="p">(</span><span class="n">myquery</span><span class="p">);</span>
            <span class="n">delay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span> <span class="c1">// small delay to wait for MySQl server to respond</span>
            <span class="n">my_conn</span><span class="p">.</span><span class="n">show_results</span><span class="p">();</span>
            <span class="n">num_fails</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//my_conn.disconnect();</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Connecting again...&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">my_conn</span><span class="p">.</span><span class="n">mysql_connect</span><span class="p">(</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">3306</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Success!&quot;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">num_fails</span><span class="o">++</span><span class="p">;</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Connect failed!&quot;</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">num_fails</span> <span class="o">==</span> <span class="n">MAX_FAILED_CONNECTS</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;No MySQL server available...&quot;</span><span class="p">);</span>
                <span class="n">delay</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
                <span class="p">}</span>
              <span class="p">}</span>
           <span class="p">}</span>
       <span class="c1">// close the database connection</span>
       <span class="n">my_conn</span><span class="p">.</span><span class="n">disconnect</span><span class="p">();</span>   
       <span class="p">}</span>
  <span class="p">}</span>

    <span class="c1">// Just prints the time so we know we are not stuck</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;Current time is  &quot;</span><span class="p">);</span>
    <span class="n">print2digits</span><span class="p">(</span><span class="n">tm</span><span class="p">.</span><span class="n">Hour</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sc">&#39;:&#39;</span><span class="p">);</span>
    <span class="n">print2digits</span><span class="p">(</span><span class="n">tm</span><span class="p">.</span><span class="n">Minute</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="sc">&#39;:&#39;</span><span class="p">);</span>
    <span class="n">print2digits</span><span class="p">(</span><span class="n">tm</span><span class="p">.</span><span class="n">Second</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
    
    <span class="c1">// Basically we check the time every 5 seconds. You can increase this</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="ftp-server-using-sd-card">
<h2>FTP Server using SD Card</h2>
<p>Being a fully-capable network device, RobotDyn Mega 2560 ETH can even act as a simple but fully functional FTP server, storing files to and serving from an SD card.</p>
<p>This FTP server is created by Github user galledojm (<a class="reference external" href="https://github.com/gallegojm">https://github.com/gallegojm</a>).</p>
<p>You can find full code as well as instructions on <a class="reference external" href="https://github.com/gallegojm/Arduino-Ftp-Server/tree/master/FtpServer">Github</a>.</p>
</div>
<div class="section" id="relay-shield-example">
<h2>Relay Shield Example</h2>
<p><img alt="Robotdyn Relay Shield" src="data:image/..jpg;base64," /></p>
<p>The RobotDyn Relay Shield provides four high quality relays with NO/NC interfaces. LED indicators show the on/off state of each relay.</p>
<p>In this tutorial we will show how to use a relay to control an LED, however, its real purpose is to control high current devices.</p>
<div class="section" id="schematics">
<h3>Schematics</h3>
<p><img alt="Robotdyn Relay Shield with LED" src="data:image/..png;base64," /></p>
</div>
</div>
<div class="section" id="code">
<h2>Code</h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">RelayControl1</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>    
 
 
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">pinMode</span><span class="p">(</span><span class="n">RelayControl1</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
<span class="p">}</span>
 
 
<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">RelayControl1</span><span class="p">,</span><span class="n">HIGH</span><span class="p">);</span><span class="c1">// NO1 and COM1 Connected (LED on)</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="c1">// wait 1000 milliseconds (1 second)</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">RelayControl1</span><span class="p">,</span><span class="n">LOW</span><span class="p">);</span><span class="c1">// NO1 and COM1 Disconnected (LED off)</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span> <span class="c1">// wait 1000 milliseconds (1 second)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="online-graph-using-mega-2560-eth-web-server-with-no-external-services">
<h2>Online Graph Using Mega 2560 ETH Web Server with No External Services</h2>
<p>In the following example, we will create a sketch that turns your Mega
ETH board to a Web Server that serves a graphical representation of a valure provided by a connected sensor (light sensor for this example). Since microcontroller resources are very limited, it is a common practice to use additional web services for more complex tasks like graphical representation of information. But if we don’t want to depend on an external service, free or commercial, we might want to try to implement everything using nothing but the board, which is actually possible.</p>
<div class="section" id="connecting-a-sensor">
<h3>Connecting a Sensor</h3>
<p>We connect a photo-resistor to 5V, GND and A0 pins of Mega 2560 ETH in such a way that the minimum light intensity is zero, while the maximum is 1024.</p>
<p><img alt="Fig 1. Sensor connection diagram" src="../../../_images/photosensor.svg" /></p>
</div>
<div class="section" id="preparing-the-web-page-on-sd-card">
<h3>Preparing the Web Page on SD Card</h3>
<p>Let’s create a simple HTML page and store it on an SD card using your
computer and a card reader. While you can use almost any text editor to
write HTML code, it will be much easier if it can highlight the HTML
syntax and automatically close HTML tags. Geany (geany.org) is an
example of such an editor available on almost all operating systems.
Create the following web page in the editor:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE HTML&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;text/html; charset=utf-8&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Super Graphing Data Logger!<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
 
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span><span class="p">&gt;</span>
<span class="kd">function</span> <span class="nx">getDataFilename</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span>
    <span class="nx">point</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s2">&quot;file=&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
 
    <span class="nx">tempString</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">point</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tempString</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
    <span class="k">return</span><span class="p">(</span><span class="nx">tempString</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="nx">tempString</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">tempString</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">));</span>
    <span class="p">}</span>
         
<span class="p">}</span>
 
<span class="nx">query</span>  <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">;</span>
 
<span class="kd">var</span> <span class="nx">dataFilePath</span> <span class="o">=</span> <span class="s2">&quot;/data/&quot;</span><span class="o">+</span><span class="nx">getDataFilename</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>
 
<span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">chart</span><span class="p">;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
     
        <span class="c1">// define the options</span>
        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
     
            <span class="nx">chart</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">renderTo</span><span class="o">:</span> <span class="s1">&#39;container&#39;</span><span class="p">,</span>
                <span class="nx">zoomType</span><span class="o">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span>
                <span class="nx">spacingRight</span><span class="o">:</span> <span class="mi">20</span>
            <span class="p">},</span>
     
            <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Light levels recorded by the Arduino&#39;</span>
            <span class="p">},</span>
     
            <span class="nx">subtitle</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Click and drag in the plot area to zoom in&#39;</span>
            <span class="p">},</span>
     
            <span class="nx">xAxis</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span>
                <span class="nx">maxZoom</span><span class="o">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">3600000</span>
            <span class="p">},</span>
     
            <span class="nx">yAxis</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Light Levels (0 - 1024)&#39;</span>
                <span class="p">},</span>
                <span class="nx">min</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="nx">startOnTick</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nx">showFirstLabel</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">},</span>
     
            <span class="nx">legend</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">enabled</span><span class="o">:</span> <span class="kc">false</span>
            <span class="p">},</span>
     
            <span class="nx">tooltip</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">formatter</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="s1">&#39;&lt;b&gt;&#39;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">series</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span><span class="s1">&#39;&lt;/b&gt;&lt;br/&gt;&#39;</span><span class="o">+</span>
                        <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">dateFormat</span><span class="p">(</span><span class="s1">&#39;%H:%M - %b %e, %Y&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">},</span>
     
            <span class="nx">plotOptions</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">series</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">cursor</span><span class="o">:</span> <span class="s1">&#39;pointer&#39;</span><span class="p">,</span>
                    <span class="nx">lineWidth</span><span class="o">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="nx">point</span><span class="o">:</span> <span class="p">{</span>
                        <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
                            <span class="nx">click</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                                <span class="nx">hs</span><span class="p">.</span><span class="nx">htmlExpand</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
                                    <span class="nx">pageOrigin</span><span class="o">:</span> <span class="p">{</span>
                                        <span class="nx">x</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span>
                                        <span class="nx">y</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">pageY</span>
                                    <span class="p">},</span>
                                    <span class="nx">headingText</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">series</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                                    <span class="nx">maincontentText</span><span class="o">:</span> <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">dateFormat</span><span class="p">(</span><span class="s1">&#39;%H:%M - %b %e, %Y&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;:&lt;br/&gt; &#39;</span><span class="o">+</span>
                                        <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
                                    <span class="nx">width</span><span class="o">:</span> <span class="mi">200</span>
                                <span class="p">});</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">},</span>
     
            <span class="nx">series</span><span class="o">:</span> <span class="p">[{</span>
                <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Light Levels&#39;</span><span class="p">,</span>
                <span class="nx">marker</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">radius</span><span class="o">:</span> <span class="mi">2</span>
                <span class="p">}</span>
            <span class="p">}]</span>
        <span class="p">};</span>
     
     
        <span class="c1">// Load data asynchronously using jQuery. On success, add the data</span>
        <span class="c1">// to the options and initiate the chart.</span>
        <span class="c1">//  http://api.jquery.com/jQuery.get/</span>

        <span class="nx">jQuery</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">dataFilePath</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">csv</span><span class="p">,</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="p">[],</span>
                <span class="nx">date</span><span class="p">,</span>
     
                <span class="c1">// set up the two data series</span>
                <span class="nx">lightLevels</span> <span class="o">=</span> <span class="p">[];</span>
     
            <span class="c1">// inconsistency</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">csv</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">csv</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
            <span class="p">}</span>
     
            <span class="c1">// split the data return into lines and parse them</span>
            <span class="nx">csv</span> <span class="o">=</span> <span class="nx">csv</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\n/g</span><span class="p">);</span>
            <span class="nx">jQuery</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">csv</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
     
                <span class="c1">// all data lines start with a double quote</span>
                <span class="nx">line</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
                <span class="nx">date</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
     
                <span class="nx">lightLevels</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
                    <span class="nx">date</span><span class="p">,</span>
                    <span class="nb">parseInt</span><span class="p">(</span><span class="nx">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
                <span class="p">]);</span>
                 
            <span class="p">});</span>
     
            <span class="nx">options</span><span class="p">.</span><span class="nx">series</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">lightLevels</span><span class="p">;</span>
     
            <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Highcharts</span><span class="p">.</span><span class="nx">Chart</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">});</span>
     
<span class="p">});</span>
        <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;text-align:center;&quot;</span><span class="p">&gt;</span>Please allow the chart to load, it may take up to 30 seconds <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">hr</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://cdnjs.cloudflare.com/ajax/libs/highcharts/2.3.5/highcharts.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
 
<span class="c">&lt;!-- Additional files for the Highslide popup effect --&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://www.highcharts.com/highslide/highslide-full.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://www.highcharts.com/highslide/highslide.config.js&quot;</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;http://www.highcharts.com/highslide/highslide.css&quot;</span> <span class="p">/&gt;</span>
 
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;container&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;min-width: 400px; height: 400px; margin: 0 auto&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
 
    <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>Store it on the SD card in the root directory as <em>index.html</em>.</p>
</div>
<div class="section" id="preparing-the-sketch">
<h3>Preparing the sketch</h3>
<p>Our sketch will be placed in EEPROM and will make use of 2 extra libraries: <a class="reference external" href="http://playground.arduino.cc/Code/EEPROMWriteAnything">EEPROMAnything</a> and <a class="reference external" href="http://playground.arduino.cc/Code/Time">Time library</a>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="cm">/* ************************************************************************</span>
<span class="cm"> * ***            Super Graphing Data Logger - EEPROM config            ***</span>
<span class="cm"> * ************************************************************************</span>
<span class="cm"> * Everett Robinson, December 2012.</span>
<span class="cm"> *</span>
<span class="cm"> * The following extra non standard libraries were used, and will need to be</span>
<span class="cm"> * added to the libraries folder:</span>
<span class="cm"> * - EEPROMAnything:  http://playground.arduino.cc/Code/EEPROMWriteAnyt...</span>
<span class="cm"> *</span>
<span class="cm"> * This sketch helps you set the values in EEPROM which are necessary for</span>
<span class="cm"> * Super Graphing Data Logger. It should only need the be run once before</span>
<span class="cm"> * the first time you set up SGDL, or in the unlikely event that the EEPROM</span>
<span class="cm"> * becomes corrupted.</span>
<span class="cm"> *</span>
<span class="cm"> * Please ensure that the values in configuration config are appropriate for</span>
<span class="cm"> * your project before uncommenting the EEPROM_writeAnything(0, config); line.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
 
<span class="cp">#include</span> <span class="cpf">&lt;EEPROM.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;EEPROMAnything.h&gt;</span><span class="cp"></span>
 
<span class="k">typedef</span> <span class="k">struct</span><span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newFileTime</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">workingFilename</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>
  <span class="p">}</span> <span class="n">configuration</span><span class="p">;</span>
 
<span class="c1">//This is a one off thing, so everything is in setup</span>
<span class="kt">void</span> <span class="nf">setup</span><span class="p">(){</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
   
  <span class="c1">//Create the config struct to write to EEPROM, change values as appropriate</span>
  <span class="c1">//Make sure your filename is not too long for the workingFilename char array </span>
  <span class="n">configuration</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1356912000L</span><span class="p">,</span><span class="s">&quot;/data/25-12-12.csv&quot;</span><span class="p">};</span>
  <span class="c1">//Write the values to the EEPROM</span>
  <span class="c1">//EEPROM_writeAnything(0, config);       //Uncomment when you&#39;re sure everything is correct</span>
  <span class="n">configuration</span> <span class="n">config2</span><span class="p">;</span>                   <span class="c1">//Create a second config struct for verification</span>
  <span class="n">EEPROM_readAnything</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">config2</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;The value read from EEPROM for newFileTime is: &quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">config2</span><span class="p">.</span><span class="n">newFileTime</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;The value read from EEPROM for workingFilename is: &quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">config2</span><span class="p">.</span><span class="n">workingFilename</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;If those values are correct then everything went as planned. Otherwise,&quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;please double check that the values declared for the struct config are&quot;</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;correct and that that EEPROM_writeAnything line is uncommented.&quot;</span><span class="p">);</span>
<span class="p">}</span>
 
 
<span class="kt">void</span> <span class="nf">loop</span><span class="p">(){</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Please mind the commented line <code class="docutils literal notranslate"><span class="pre">//EEPROM_writeAnything(0,</span> <span class="pre">config);</span></code> - uncomment it when you are sure that everything is correct.</p>
</div>
<div class="section" id="the-main-sketch">
<h3>The main sketch</h3>
<p>You will need to do a few adjustments to the code, like MAC and IP addresses. You can also adjust the timeserver address to your liking.</p>
<p>The code is set up to make measurements every 10 minutes, and to create a new datafile every week. Data files use a dd-mm-yy.csv format.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="cm">/* ************************************************************************</span>
<span class="cm"> * ***                    Super Graphing Data Logger                    ***</span>
<span class="cm"> * ************************************************************************</span>
<span class="cm"> * Everett Robinson, December 2012. More at:  http://everettsprojects.com</span>
<span class="cm"> *</span>
<span class="cm"> * This sketch relies on the SD and ethernet libraries in arduino 1.0 or newer.</span>
<span class="cm"> * The following extra non standard libraries were also used, and will need to</span>
<span class="cm"> * be added to the libraries folder:</span>
<span class="cm"> * - Time:  http://everettsprojects.com</span>
<span class="cm"> * - EEPROMAnything:  http://everettsprojects.com</span>
<span class="cm"> *</span>
<span class="cm"> * If this is your first time setting up this project, please go get the</span>
<span class="cm"> * EEPROM_config sketch from  http://everettsprojects.com so that you can </span>
<span class="cm"> * configure the config struct in the EEPROM memory. Usage of the EEPROM </span>
<span class="cm"> * is needed to make the project resilient against a temporary loss of power.</span>
<span class="cm"> *</span>
<span class="cm"> * You must also ensure that you have the HC.htm file in the root directory</span>
<span class="cm"> * of your SD card, as well as a data directory where the datafiles will be</span>
<span class="cm"> * stored.</span>
<span class="cm"> *</span>
<span class="cm"> * This sketch combines the functionality of an existing fileserver example</span>
<span class="cm"> * which can be found at  http://everettsprojects.com</span>
<span class="cm"> * with the Datalogger example that comes with the new SD library from 1.0,</span>
<span class="cm"> * as well as some code from the UdpNtpClient example that cones with the</span>
<span class="cm"> * ethernet library. </span>
<span class="cm"> *</span>
<span class="cm"> * Added to all of these are some tricks to make it manage and serve up the</span>
<span class="cm"> * datafiles in conjunction with a page which uses highcharts JS to graph it.</span>
<span class="cm"> * This is basically accomplished using the arduino by itself. Because I</span>
<span class="cm"> * actually host the highcharts.js files externally, this is true more in</span>
<span class="cm"> * theory than in actual practice, but oh well. It should work just fine to</span>
<span class="cm"> * have the highcharts.js file on the arduino&#39;s SD card, though loading the </span>
<span class="cm"> * page will be painfully slow.</span>
<span class="cm"> *</span>
<span class="cm"> * Some of the code this was derived from may or may not be under a GPL</span>
<span class="cm"> * license; I&#39;m not entirely sure. I suppose anyone using this should treat </span>
<span class="cm"> * it like it is too, but I don&#39;t really care too much.</span>
<span class="cm"> * Also if one intends to use this for commercial applications, it may be</span>
<span class="cm"> * necessary to purchase a license for Highcharts.</span>
<span class="cm"> *</span>
<span class="cm"> * Changes:   -------------------------------------------------------------</span>
<span class="cm"> * January 2013: Updated so that the dd-mm-yy.csv file format is properly </span>
<span class="cm"> * followed, all single digit days, months, and years will have a leading </span>
<span class="cm"> * zero now. </span>
<span class="cm"> *</span>
<span class="cm"> */</span>
 
<span class="cp">#include</span> <span class="cpf">&lt;sd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;ethernet.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;ethernetudp.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;spi.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;eeprom.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;eepromanything.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;avr/pgmspace.h&gt;</span><span class="cp"></span>
 
<span class="cm">/************ ETHERNET STUFF ************/</span>
<span class="n">byte</span> <span class="n">mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xA2</span><span class="p">,</span> <span class="mh">0xDA</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="mh">0x64</span> <span class="p">};</span>
<span class="n">byte</span> <span class="n">ip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">192</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span> <span class="p">};</span>
<span class="n">EthernetServer</span> <span class="nf">server</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>
 
<span class="cm">/************** NTP STUFF ***************/</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">localPort</span> <span class="o">=</span> <span class="mi">8888</span><span class="p">;</span>          <span class="c1">// local port to listen for UDP packets</span>
<span class="n">IPAddress</span> <span class="nf">timeServer</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">101</span><span class="p">);</span> <span class="c1">//NIST time server IP address: for more info</span>
                                        <span class="c1">//see  http://everettsprojects.com</span>
 
<span class="k">const</span> <span class="kt">int</span> <span class="n">NTP_PACKET_SIZE</span><span class="o">=</span> <span class="mi">48</span><span class="p">;</span> <span class="c1">//NTP time stamp is in the first 48 bytes of the message</span>
<span class="n">byte</span> <span class="n">packetBuffer</span><span class="p">[</span> <span class="n">NTP_PACKET_SIZE</span><span class="p">];</span> <span class="c1">//buffer to hold incoming and outgoing packets </span>
<span class="n">EthernetUDP</span> <span class="n">Udp</span><span class="p">;</span>
 
<span class="cm">/*** DATA LOGGER AND TIMER CONTROLS ****/</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">analogPin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lastIntervalTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//The time the last measurement occurred.</span>
<span class="cp">#define MEASURE_INTERVAL 600000     </span><span class="c1">//10 minute intervals between measurements (in ms)</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newFileTime</span><span class="p">;</span>          <span class="c1">//The time at which we should create a new week&#39;s file</span>
<span class="cp">#define FILE_INTERVAL 604800        </span><span class="c1">//One week worth of seconds</span>
 
<span class="c1">//A structure that stores file config variables from EEPROM</span>
<span class="k">typedef</span> <span class="k">struct</span><span class="p">{</span>                     
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">newFileTime</span><span class="p">;</span>      <span class="c1">//Keeps track of when a new file should be made.</span>
    <span class="kt">char</span> <span class="n">workingFilename</span><span class="p">[</span><span class="mi">19</span><span class="p">];</span>       <span class="c1">//The path and filename of the current week&#39;s file</span>
<span class="p">}</span> <span class="n">configuration</span><span class="p">;</span>
   
<span class="n">configuration</span> <span class="n">config</span><span class="p">;</span>               <span class="c1">//Actually make our config struct</span>
 
 
<span class="c1">// Strings stored in flash mem for the HTML Header (saves ram)</span>
<span class="n">prog_char</span> <span class="n">HeaderOK_0</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;HTTP/1.1 200 OK&quot;</span><span class="p">;</span>            <span class="c1">//</span>
<span class="n">prog_char</span> <span class="n">HeaderOK_1</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;Content-Type: text/html&quot;</span><span class="p">;</span>    <span class="c1">//</span>
<span class="n">prog_char</span> <span class="n">HeaderOK_2</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>                           <span class="c1">//</span>
 
<span class="c1">// A table of pointers to the flash memory strings for the header</span>
<span class="n">PROGMEM</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">HeaderOK_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>   
  <span class="n">HeaderOK_0</span><span class="p">,</span>
  <span class="n">HeaderOK_1</span><span class="p">,</span>
  <span class="n">HeaderOK_2</span>
<span class="p">};</span>
 
<span class="c1">// A function for easy printing of the headers  </span>
<span class="kt">void</span> <span class="nf">HtmlHeaderOK</span><span class="p">(</span><span class="n">EthernetClient</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
   
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span> <span class="c1">//A character array to hold the strings from the flash mem</span>
     
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">strcpy_P</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pgm_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">HeaderOK_table</span><span class="p">[</span><span class="n">i</span><span class="p">])));</span> 
      <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span> <span class="n">buffer</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span> 
   
   
<span class="c1">// Strings stored in flash mem for the Html 404 Header</span>
<span class="n">prog_char</span> <span class="n">Header404_0</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;HTTP/1.1 404 Not Found&quot;</span><span class="p">;</span>     <span class="c1">//</span>
<span class="n">prog_char</span> <span class="n">Header404_1</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;Content-Type: text/html&quot;</span><span class="p">;</span>    <span class="c1">//</span>
<span class="n">prog_char</span> <span class="n">Header404_2</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>                           <span class="c1">//</span>
<span class="n">prog_char</span> <span class="n">Header404_3</span><span class="p">[]</span> <span class="n">PROGMEM</span> <span class="o">=</span> <span class="s">&quot;&lt;h2&gt;File Not Found!&lt;/h2&gt;&quot;</span><span class="p">;</span> 
 
<span class="c1">// A table of pointers to the flash memory strings for the header</span>
<span class="n">PROGMEM</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Header404_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>   
  <span class="n">Header404_0</span><span class="p">,</span>
  <span class="n">Header404_1</span><span class="p">,</span>
  <span class="n">Header404_2</span><span class="p">,</span>
  <span class="n">Header404_3</span>
<span class="p">};</span>
 
<span class="c1">// Easy peasy 404 header function</span>
<span class="kt">void</span> <span class="nf">HtmlHeader404</span><span class="p">(</span><span class="n">EthernetClient</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
   
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span> <span class="c1">//A character array to hold the strings from the flash mem</span>
     
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">strcpy_P</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pgm_read_word</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">Header404_table</span><span class="p">[</span><span class="n">i</span><span class="p">])));</span> 
      <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span> <span class="n">buffer</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span> 
 
 
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
   
  <span class="n">pinMode</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>          <span class="c1">// set the SS pin as an output (necessary!)</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>       <span class="c1">// but turn off the W5100 chip! </span>
   
  <span class="c1">// see if the card is present and can be initialized:</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SD</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Card failed, or not present&quot;</span><span class="p">);</span>
    <span class="c1">// don&#39;t do anything more:</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;card initialized.&quot;</span><span class="p">);</span>
   
  <span class="c1">// The SD card is working, start the server and ethernet related stuff!</span>
  <span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
  <span class="n">server</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="n">Udp</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">localPort</span><span class="p">);</span>
  <span class="n">EEPROM_readAnything</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">config</span><span class="p">);</span> <span class="c1">// make sure our config struct is syncd with EEPROM</span>
<span class="p">}</span>
 
 
<span class="c1">// A function that takes care of the listing of files for the</span>
<span class="c1">// main page one sees when they first connect to the arduino.</span>
<span class="c1">// it only lists the files in the /data/ folder. Make sure this</span>
<span class="c1">// exists on your SD card.</span>
<span class="kt">void</span> <span class="nf">ListFiles</span><span class="p">(</span><span class="n">EthernetClient</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
   
  <span class="n">File</span> <span class="n">workingDir</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/data&quot;</span><span class="p">);</span>
   
  <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;&lt;ul&gt;&quot;</span><span class="p">);</span>
   
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">File</span> <span class="n">entry</span> <span class="o">=</span>  <span class="n">workingDir</span><span class="p">.</span><span class="n">openNextFile</span><span class="p">();</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">break</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="n">client</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;&lt;li&gt;&lt;a href=</span><span class="se">\&quot;</span><span class="s">/HC.htm?file=&quot;</span><span class="p">);</span>
       <span class="n">client</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">());</span>        
       <span class="n">client</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&gt;&quot;</span><span class="p">);</span>
       <span class="n">client</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">name</span><span class="p">());</span>
       <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;&lt;/a&gt;&lt;/li&gt;&quot;</span><span class="p">);</span>
       <span class="n">entry</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;&lt;/ul&gt;&quot;</span><span class="p">);</span>
  <span class="n">workingDir</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="c1">// A function to get the Ntp Time. This is used to make sure that the data</span>
<span class="c1">// points recorded by the arduino are referenced to some meaningful time</span>
<span class="c1">// which in our case is UTC represented as unix time (chosen because it </span>
<span class="c1">// works simply with highcharts without too much unnecessary computation).</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">getTime</span><span class="p">(){</span>
  <span class="n">sendNTPpacket</span><span class="p">(</span><span class="n">timeServer</span><span class="p">);</span> <span class="c1">// send an NTP packet to a time server</span>
 
  <span class="c1">// wait to see if a reply is available</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>  
  <span class="k">if</span> <span class="p">(</span> <span class="n">Udp</span><span class="p">.</span><span class="n">parsePacket</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>  
    <span class="c1">// We&#39;ve received a packet, read the data from it</span>
    <span class="n">Udp</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span><span class="n">NTP_PACKET_SIZE</span><span class="p">);</span>  <span class="c1">// read the packet into the buffer</span>
 
    <span class="c1">//the timestamp starts at byte 40 of the received packet and is four bytes,</span>
    <span class="c1">// or two words, long. First, esxtract the two words:</span>
 
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">highWord</span> <span class="o">=</span> <span class="n">word</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">[</span><span class="mi">40</span><span class="p">],</span> <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">41</span><span class="p">]);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lowWord</span> <span class="o">=</span> <span class="n">word</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">[</span><span class="mi">42</span><span class="p">],</span> <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">43</span><span class="p">]);</span>  
    <span class="c1">// combine the four bytes (two words) into a long integer</span>
    <span class="c1">// this is NTP time (seconds since Jan 1 1900):</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">secsSince1900</span> <span class="o">=</span> <span class="n">highWord</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">lowWord</span><span class="p">;</span>  
    <span class="c1">// Unix time starts on Jan 1 1970. In seconds, that&#39;s 2208988800:</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seventyYears</span> <span class="o">=</span> <span class="mi">2208988800UL</span><span class="p">;</span>     
    <span class="c1">// subtract seventy years:</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">epoch</span> <span class="o">=</span> <span class="n">secsSince1900</span> <span class="o">-</span> <span class="n">seventyYears</span><span class="p">;</span>  
    <span class="c1">// return Unix time:</span>
    <span class="k">return</span> <span class="n">epoch</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">// send an NTP request to the time server at the given address,</span>
<span class="c1">// necessary for getTime().</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">sendNTPpacket</span><span class="p">(</span><span class="n">IPAddress</span><span class="o">&amp;</span> <span class="n">address</span><span class="p">){</span>
   
  <span class="c1">// set all bytes in the buffer to 0</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NTP_PACKET_SIZE</span><span class="p">);</span> 
  <span class="c1">// Initialize values needed to form NTP request</span>
  <span class="c1">// (see URL above for details on the packets)</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="n">b11100011</span><span class="p">;</span>   <span class="c1">// LI, Version, Mode</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">// Stratum, or type of clock</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>     <span class="c1">// Polling Interval</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xEC</span><span class="p">;</span>  <span class="c1">// Peer Clock Precision</span>
  <span class="c1">// 8 bytes of zero for Root Delay &amp; Root Dispersion</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">49</span><span class="p">;</span> 
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x4E</span><span class="p">;</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">49</span><span class="p">;</span>
  <span class="n">packetBuffer</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">52</span><span class="p">;</span>
 
  <span class="c1">// all NTP fields have been given values, now</span>
  <span class="c1">// you can send a packet requesting a timestamp:         </span>
  <span class="n">Udp</span><span class="p">.</span><span class="n">beginPacket</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">123</span><span class="p">);</span> <span class="c1">//NTP requests are to port 123</span>
  <span class="n">Udp</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">packetBuffer</span><span class="p">,</span><span class="n">NTP_PACKET_SIZE</span><span class="p">);</span>
  <span class="n">Udp</span><span class="p">.</span><span class="n">endPacket</span><span class="p">();</span> 
<span class="p">}</span>
 
 
<span class="c1">// How big our line buffer should be for sending the files over the ethernet.</span>
<span class="c1">// 75 has worked fine for me so far.</span>
<span class="cp">#define BUFSIZ 75</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">millis</span><span class="p">()</span> <span class="o">%</span> <span class="n">lastIntervalTime</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MEASURE_INTERVAL</span><span class="p">){</span> <span class="c1">//Is it time for a new measurement?</span>
      
    <span class="kt">char</span> <span class="n">dataString</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rawTime</span><span class="p">;</span>
    <span class="n">rawTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>
 
    <span class="k">while</span><span class="p">((</span><span class="n">rawTime</span> <span class="o">==</span> <span class="mi">39</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)){</span>     <span class="c1">//server seems to send 39 as an error code</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>                              <span class="c1">//we want to retry if this happens. I chose</span>
      <span class="n">rawTime</span> <span class="o">=</span> <span class="n">getTime</span><span class="p">();</span>                      <span class="c1">//12 retries because I&#39;m stubborn/persistent.</span>
      <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>                               <span class="c1">//NIST considers retry interval of &lt;4s as DoS</span>
    <span class="p">}</span>                                           <span class="c1">//attack, so fair warning.</span>
     
    <span class="k">if</span> <span class="p">(</span><span class="n">rawTime</span> <span class="o">!=</span> <span class="mi">39</span><span class="p">){</span>                         <span class="c1">//If that worked, and we have a real time</span>
       
      <span class="c1">//Decide if it&#39;s time to make a new file or not. Files are broken</span>
      <span class="c1">//up like this to keep loading times for each chart bearable.</span>
      <span class="c1">//Lots of string stuff happens to make a new filename if necessary.</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">rawTime</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="p">.</span><span class="n">newFileTime</span><span class="p">){</span>
        <span class="kt">int</span> <span class="n">dayInt</span> <span class="o">=</span> <span class="n">day</span><span class="p">(</span><span class="n">rawTime</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">monthInt</span> <span class="o">=</span> <span class="n">month</span><span class="p">(</span><span class="n">rawTime</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">yearInt</span> <span class="o">=</span> <span class="n">year</span><span class="p">(</span><span class="n">rawTime</span><span class="p">);</span>
        <span class="kt">char</span> <span class="n">newFilename</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">dayStr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">monthStr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">yearStr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">subYear</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;data/&quot;</span><span class="p">);</span>
        <span class="n">itoa</span><span class="p">(</span><span class="n">dayInt</span><span class="p">,</span><span class="n">dayStr</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dayInt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">){</span>
          <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;0&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="n">dayStr</span><span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;-&quot;</span><span class="p">);</span>
        <span class="n">itoa</span><span class="p">(</span><span class="n">monthInt</span><span class="p">,</span><span class="n">monthStr</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">monthInt</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">){</span>
          <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;0&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="n">monthStr</span><span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;-&quot;</span><span class="p">);</span>
        <span class="n">itoa</span><span class="p">(</span><span class="n">yearInt</span><span class="p">,</span><span class="n">yearStr</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
        <span class="c1">//we only want the last two digits of the year</span>
        <span class="n">memcpy</span><span class="p">(</span> <span class="n">subYear</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">yearStr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">3</span> <span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="n">subYear</span><span class="p">);</span>
        <span class="n">strcat</span><span class="p">(</span><span class="n">newFilename</span><span class="p">,</span><span class="s">&quot;.csv&quot;</span><span class="p">);</span>
         
        <span class="c1">//make sure we update our config variables:</span>
        <span class="n">config</span><span class="p">.</span><span class="n">newFileTime</span> <span class="o">+=</span> <span class="n">FILE_INTERVAL</span><span class="p">;</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">workingFilename</span><span class="p">,</span><span class="n">newFilename</span><span class="p">);</span>
        <span class="c1">//Write the changes to EEPROM. Bad things may happen if power is lost midway through,</span>
        <span class="c1">//but it&#39;s a small risk we take. Manual fix with EEPROM_config sketch can correct it.</span>
        <span class="n">EEPROM_writeAnything</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span> 
      <span class="p">}</span>
         
      <span class="c1">//get the values and setup the string we want to write to the file</span>
      <span class="kt">int</span> <span class="n">sensor</span> <span class="o">=</span> <span class="n">analogRead</span><span class="p">(</span><span class="n">analogPin</span><span class="p">);</span>  
      <span class="kt">char</span> <span class="n">timeStr</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
      <span class="kt">char</span> <span class="n">sensorStr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
       
      <span class="n">ultoa</span><span class="p">(</span><span class="n">rawTime</span><span class="p">,</span><span class="n">timeStr</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span> 
      <span class="n">itoa</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span><span class="n">sensorStr</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
       
      <span class="n">strcat</span><span class="p">(</span><span class="n">dataString</span><span class="p">,</span><span class="n">timeStr</span><span class="p">);</span>
      <span class="n">strcat</span><span class="p">(</span><span class="n">dataString</span><span class="p">,</span><span class="s">&quot;,&quot;</span><span class="p">);</span>
      <span class="n">strcat</span><span class="p">(</span><span class="n">dataString</span><span class="p">,</span><span class="n">sensorStr</span><span class="p">);</span>
       
      <span class="c1">//open the file we&#39;ll be writing to.</span>
      <span class="n">File</span> <span class="n">dataFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">workingFilename</span><span class="p">,</span> <span class="n">FILE_WRITE</span><span class="p">);</span>
   
      <span class="c1">// if the file is available, write to it:</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">dataFile</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dataFile</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">dataString</span><span class="p">);</span>
        <span class="n">dataFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
        <span class="c1">// print to the serial port too:</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">dataString</span><span class="p">);</span>
      <span class="p">}</span>  
      <span class="c1">// if the file isn&#39;t open, pop up an error:</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Error opening datafile for writing&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t resolve a time from the Ntp Server.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//Update the time of the last measurment to the current timer value</span>
    <span class="n">lastIntervalTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="c1">//No measurements to be made, make sure the webserver is available for connections.</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="kt">char</span> <span class="n">clientline</span><span class="p">[</span><span class="n">BUFSIZ</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     
    <span class="n">EthernetClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">available</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// an http request ends with a blank line</span>
      <span class="n">boolean</span> <span class="n">current_line_is_blank</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
       
      <span class="c1">// reset the input buffer</span>
      <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       
      <span class="k">while</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
          <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">read</span><span class="p">();</span>
           
          <span class="c1">// If it isn&#39;t a new line, add the character to the buffer</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">clientline</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
            <span class="n">index</span><span class="o">++</span><span class="p">;</span>
            <span class="c1">// are we too big for the buffer? start tossing out data</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">BUFSIZ</span><span class="p">)</span> 
              <span class="n">index</span> <span class="o">=</span> <span class="n">BUFSIZ</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
             
            <span class="c1">// continue to read more data!</span>
            <span class="k">continue</span><span class="p">;</span>
          <span class="p">}</span>
           
          <span class="c1">// got a \n or \r new line, which means the string is done</span>
          <span class="n">clientline</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
           
          <span class="c1">// Print it out for debugging</span>
          <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">clientline</span><span class="p">);</span>
           
          <span class="c1">// Look for substring such as a request to get the root file</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">clientline</span><span class="p">,</span> <span class="s">&quot;GET / &quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// send a standard http response header</span>
            <span class="n">HtmlHeaderOK</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
            <span class="c1">// print all the data files, use a helper to keep it clean</span>
            <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;&lt;h2&gt;View data for the week of (dd-mm-yy):&lt;/h2&gt;&quot;</span><span class="p">);</span>
            <span class="n">ListFiles</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">clientline</span><span class="p">,</span> <span class="s">&quot;GET /&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// this time no space after the /, so a sub-file!</span>
            <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
             
            <span class="n">filename</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">clientline</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;?&quot;</span><span class="p">);</span> <span class="c1">// look after the &quot;GET /&quot; (5 chars) but before</span>
            <span class="c1">// the &quot;?&quot; if a data file has been specified. A little trick, look for the &quot; HTTP/1.1&quot;</span>
            <span class="c1">// string and turn the first character of the substring into a 0 to clear it out.</span>
            <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">clientline</span><span class="p">,</span> <span class="s">&quot; HTTP&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             
            <span class="c1">// print the file we want</span>
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
            <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">FILE_READ</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">HtmlHeader404</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
             
            <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Opened!&quot;</span><span class="p">);</span>
                       
            <span class="n">HtmlHeaderOK</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
             
            <span class="kt">int16_t</span> <span class="n">c</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">file</span><span class="p">.</span><span class="n">read</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// uncomment the serial to debug (slow!)</span>
                <span class="c1">//Serial.print((char)c);</span>
                <span class="n">client</span><span class="p">.</span><span class="n">print</span><span class="p">((</span><span class="kt">char</span><span class="p">)</span><span class="n">c</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">file</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// everything else is a 404</span>
            <span class="n">HtmlHeader404</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// give the web browser time to receive the data</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="n">client</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
 
</pre></div>
</div>
</div>
<div class="section" id="the-results">
<h3>The Results</h3>
<p><img alt="Fig.1" src="data:image/..jpg;base64," />
<img alt="Fig.2" src="data:image/..jpg;base64," />
<img alt="Fig.3" src="data:image/..jpg;base64," /></p>
</div>
</div>
<div class="section" id="web-server">
<h2>Web Server</h2>
<p>In the following example, we will create a sketch that turns your Mega
ETH board to a Web Server that serves just one static HTML page that it
reads from a file on an SD card.</p>
<div class="section" id="creating-the-web-page">
<h3>Creating the Web Page</h3>
<p>Let’s create a simple HTML page and store it on an SD card using your
computer and a card reader. While you can use almost any text editor to
write HTML code, it will be much easier if it can highlight the HTML
syntax and automatically close HTML tags. Geany (geany.org) is an
example of such an editor available on almost all operating systems.
Create the following web page in the editor:</p>
<div class="highlight-{.sourceCode .HTML} notranslate"><div class="highlight"><pre><span></span>&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Test SD Card Web Page&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Hello from the Mega ETH Web Server!&lt;/h1&gt;
        &lt;p&gt;An example web page stored on the SD card.&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>Store it on the SD card in the root directory as <em>index.html</em>.</p>
</div>
<div class="section" id="preparing-the-web-server-sketch">
<h3>Preparing the Web-Server Sketch</h3>
<p>We will need to configure the pin 4 for the SD card reader to work, then
we initialize the network library, generate a presumably unique MAC
address following our previous recommendations of setting the first byte
of MAC address to 0xDE for better network equipment compatibility and
store that MAC address in the microcontroller’s EEPROM.</p>
<p>We will use DHCP to query an available IP address from the network
router and display the IP address on a 16x2 LCD monitor because we need
to type that IP address into a browser, that must be running on a
computer on the same local network.</p>
<p>We assume that the HTML file is already stored on the SD card and the
card is inserted into the onboard card reader.</p>
<p>Let’s get down to the code:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Ethernet3.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;EEPROM.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;LiquidCrystal.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;SD.h&gt;</span><span class="cp"></span>

<span class="n">byte</span> <span class="n">mac</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xDE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
<span class="kt">char</span> <span class="n">macstr</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>

<span class="c1">// initialize the LCD library with the numbers of the interface pins</span>
<span class="n">LiquidCrystal</span> <span class="nf">lcd</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="n">EthernetServer</span> <span class="nf">server</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span>  <span class="c1">// create a server at port 80</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>

  <span class="n">lcd</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">//Initialize the 16x2 LCD screen</span>

  <span class="c1">// Check EEPROM byte with offset==0 for “#” char. The presence of “#” in the first byte of EEPROM will be a sign that the MAC address was already generated and stored in bytes 1-7 of EEPROM. Otherwise, we need to generate a random MAC, put “#” at offset 0 and the MAC in the following 6 bytes</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">EEPROM</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">EEPROM</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">randomSeed</span><span class="p">(</span><span class="n">analogRead</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
    <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xde</span><span class="p">;</span>
    <span class="n">EEPROM</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
      <span class="n">EEPROM</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">EEPROM</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;#&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Startup networking, get IP, DNS, and subnet from the DHCP server</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">linkStatus</span><span class="p">()</span> <span class="o">==</span> <span class="n">LinkOFF</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">lcd</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;LINK FAILURE&quot;</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
            <span class="n">lcd</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">&quot;DHCP ERROR!&quot;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="c1">// success, display your local IP address:</span>
         <span class="n">lcd</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">Ethernet</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span> <span class="c1">//You can enter this IP in your web browser</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// listen for incoming clients</span>
  <span class="n">EthernetClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">available</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// got client?</span>
        <span class="n">boolean</span> <span class="n">currentLineIsBlank</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>   <span class="c1">// client data available to read</span>
                <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">read</span><span class="p">();</span> <span class="c1">// read 1 byte (character) from client</span>
                <span class="c1">// last line of client request is blank and ends with \n</span>
                <span class="c1">// respond to client only after last line received</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">currentLineIsBlank</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// send a standard http response header</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;HTTP/1.1 200 OK&quot;</span><span class="p">);</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Content-Type: text/html&quot;</span><span class="p">);</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Connection: close&quot;</span><span class="p">);</span>
                    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
                    <span class="c1">// send web page</span>
                    <span class="n">webFile</span> <span class="o">=</span> <span class="n">SD</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;index.htm&quot;</span><span class="p">);</span>        <span class="c1">// open web page file</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">webFile</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">while</span><span class="p">(</span><span class="n">webFile</span><span class="p">.</span><span class="n">available</span><span class="p">())</span> <span class="p">{</span>
                            <span class="n">client</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">webFile</span><span class="p">.</span><span class="n">read</span><span class="p">());</span> <span class="c1">// send web page to client</span>
                        <span class="p">}</span>
                        <span class="n">webFile</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// every line of text received from the client ends with \r\n</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// last character on line of received text</span>
                    <span class="c1">// starting new line with next character read</span>
                    <span class="n">currentLineIsBlank</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="p">}</span> 
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// a text character was received from client</span>
                    <span class="n">currentLineIsBlank</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="c1">// end if (client.available())</span>
        <span class="p">}</span> <span class="c1">// end while (client.connected())</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>      <span class="c1">// give the web browser time to receive the data</span>
        <span class="n">client</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span> <span class="c1">// close the connection</span>
    <span class="p">}</span> <span class="c1">// end of session with client</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="saving-temperature-sensor-data-to-google-docs">
<h2>Saving Temperature Sensor Data to Google Docs</h2>
<p>This example uses a free helper service from pushingbox.com to store
temperature sensor data to a Google Sheets document.</p>
<div class="section" id="get-accounts">
<h3>Get Accounts</h3>
<ol class="simple">
<li>A regular Google account. Don’t use your main Gmail account please)</li>
<li>Get a user account on pushingbox.com. FREE!</li>
</ol>
</div>
<div class="section" id="create-a-google-form-and-get-form-key">
<h3>Create a Google Form and Get FORM KEY</h3>
</div>
</div>
<hr class="docutils" />
<div class="section" id="fig-1-create-a-new-form-fig-2-make-a-simple-text-form-and-click-send-form-fig-3-copy-form-url-fig-4-view-page-source-and-copy-the-text-input-box-id">
<h2><img alt="Fig 1. Create a new form" src="data:image/..jpg;base64," />   <img alt="Fig 2. Make a simple TEXT form and click Send Form" src="data:image/..jpg;base64," />
<img alt="Fig 3. Copy form URL" src="data:image/..jpg;base64," />      <img alt="Fig 4. View page source and copy the Text input box ID" src="data:image/..jpg;base64," /></h2>
<p>Go to your new Google Drive and create a form. In this example I use a
single question TEXT response form. Click <em>send form</em> when done.</p>
<p>There will be a pop-up shown with an option to copy a URL - click that
to copy this URL. Open this URL in another tab of your browser. This
will get you to the newly created form. Now,right-click and select
<em>Inspect Elements</em>. You will see the HTML code of the form. What you
need to find is a line of code that defines the Text input box,
something like <em>entry.123456789456123</em> (numbers will be different). This
is your <strong>form key</strong>, you will need to copy it.</p>
<div class="section" id="pushingbox-service-and-scenarios">
<h3>Pushingbox, Service and Scenarios</h3>
</div>
</div>
<hr class="docutils" />
<div class="section" id="fig-1-create-a-new-custom-service-fig-2-copy-response-page-url-and-paste-to-pushingbox-com-service-url-field">
<h2><img alt="Fig 1. Create a new custom service" src="data:image/..jpg;base64," />   <img alt="Fig 2. Copy response page URL and paste to pushingbox.com Service URL field" src="data:image/..jpg;base64," /></h2>
<p>Log in to pushingbox.com using the same Google account. Go to <em>My
Services</em> and create a new custom service. Now please go to your Google
form and submit something. This loads a response page of a form. Copy
it’s URL and paste to pushingbox.com Service URL field. Give it some
good name and set method to GET.</p>
<p>Now go to my scenarios and paste into a scenario field:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>
?entry.1917223082=$status$&amp;submit=Submit
</pre></div>
</div>
<p>Change the numbers to your own FORM KEY. Copy the whole string and paste
it into the <em>add scenario field</em>. Click ADD. Pushingbox should confirm.
Click <strong>ADD AN ACTION</strong> and select the Service you created a moment ago.</p>
<p>This will give you a DEVICE ID remember this, in fact. write it down or
copy and paste it into a notepad doc. This will be used in the Mega ETH
code.</p>
<p>Congrats, you are done with that and now its time to work on the sketch
for the Mega ETH.</p>
<div class="section" id="sketch-for-the-mega-eth">
<h3>Sketch for the Mega ETH</h3>
<p>Here we post a very simple code to run this example. You will find a
section of things to be edited. This code will send responses to the
form you created in the form of data. You will see google then creates a
spreadsheet and logs all the responses WITH time stamps! Use this to
create data logs of temperature, light levels, humidity, motion whatever
you want! The example attached uses a DHT11 thermo/humidity sensor. You
can easily modify it for your actual purpose.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span>
<span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;Ethernet3.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;EthernetUdp.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;SPI.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dht11.h&gt; </span><span class="cp"></span>

<span class="cp">#undef int</span>
<span class="cp">#undef abs</span>
<span class="cp">#undef double</span>
<span class="cp">#undef float</span>
<span class="cp">#undef round</span>
<span class="n">dht11</span> <span class="n">DHT11</span><span class="p">;</span>
<span class="cp">#define DHT11PIN 3</span>

<span class="c1">///////////////////////////////</span>
<span class="c1">///      EDIT THIS STUFF     //</span>
<span class="c1">///////////////////////////////</span>

<span class="n">byte</span> <span class="n">mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xBB</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="mh">0xDD</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">,</span> <span class="mh">0xFF</span> <span class="p">};</span>  <span class="c1">//Replace with your MAC</span>
<span class="n">byte</span> <span class="n">ip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">192</span><span class="p">,</span><span class="mi">168</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">};</span>     <span class="c1">// Your Mega ETH device IP address</span>

<span class="kt">char</span> <span class="n">devid</span> <span class="o">=</span> <span class="n">v42FE15BC09B20df</span>  <span class="c1">// THIS IS THE DEVICE ID FROM PUSHINGBOX</span>

<span class="kt">int</span> <span class="n">del</span><span class="o">=</span><span class="mi">300</span><span class="p">;</span>  <span class="c1">// Amount of seconds delay between posting to google docs.</span>

<span class="c1">///////////////////////////////</span>
<span class="c1">//       DONE EDITING        //</span>
<span class="c1">///////////////////////////////</span>

<span class="kt">char</span> <span class="n">postmsg</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">temp_av</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">server</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;api.pushingbox.com&quot;</span><span class="p">;</span>
<span class="n">EthernetClient</span> <span class="n">client</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
  <span class="n">Ethernet</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;connecting...&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">(){</span>

<span class="c1">// average temp reading for &#39;del&#39; time.........................................</span>

  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">del</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Read local temp........................................</span>
    <span class="kt">int</span> <span class="n">chk</span> <span class="o">=</span> <span class="n">DHT11</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">DHT11PIN</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">Fahrenheit</span><span class="p">(</span><span class="n">DHT11</span><span class="p">.</span><span class="n">temperature</span><span class="p">);</span>
    <span class="n">temp_av</span><span class="o">=</span><span class="n">temp_av</span><span class="o">+</span><span class="n">temp</span><span class="p">;</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">avtemp</span><span class="o">=</span><span class="n">temp_av</span><span class="o">/</span><span class="p">(</span><span class="n">del</span><span class="p">);</span>
  <span class="n">temp_av</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

  <span class="c1">// Post to Google Form.............................................</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span> 
  <span class="p">{</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;connected&quot;</span><span class="p">);</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">postmsg</span><span class="p">,</span><span class="s">&quot;GET /pushingbox?devid=%c&amp;status=%d HTTP/1.1&quot;</span><span class="p">,</span><span class="n">devid</span><span class="p">,</span><span class="n">avtemp</span><span class="p">);</span>  <span class="c1">// NOTE** In this line of code you can see where the temperature value is inserted into the wed address. It follows &#39;status=&#39; Change that value to whatever you want to post.</span>
    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">postmsg</span><span class="p">);</span>
    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Host: api.pushingbox.com&quot;</span><span class="p">);</span>
    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Connection: close&quot;</span><span class="p">);</span>
    <span class="n">client</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>

    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">postmsg</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Host: api.pushingbox.com&quot;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Connection: close&quot;</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>

    <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="n">client</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> 
  <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;disconnecting.&quot;</span><span class="p">);</span>
    <span class="n">client</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
    <span class="n">k</span><span class="o">==</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="kt">double</span> <span class="nf">Fahrenheit</span><span class="p">(</span><span class="kt">double</span> <span class="n">celsius</span><span class="p">)</span> <span class="c1">// Function to convert to Fahrenheit</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mf">1.8</span> <span class="o">*</span> <span class="n">celsius</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>
    
</pre></div>
</div>
</div>
</div>
</div>


          </div>
          
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, RobotDyn.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/MEGA2560-EthernetW5500/en/Tutorials/basic-use-cases-of-mega-2560-eth.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>